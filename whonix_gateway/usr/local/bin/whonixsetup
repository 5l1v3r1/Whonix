#!/bin/bash

## Debugging
#set -x
#export PATH=$PATH:/home/user/Whonix/whonix_gateway/usr/local/bin/

error_handler() {
   local MSG="\
###########################################################
## Something went wrong. Please report this bug!
##
## BASH_COMMAND: $BASH_COMMAND
###########################################################\
"
   echo "$MSG"
   exit 1
} 

trap "error_handler" ERR

if [ "$(id -u)" != "0" ]; then
    echo "ERROR: This must be run as root (sudo)!"
    exit 1
fi

## sanity tests
## >/dev/null hides stdout, but not stderr,
## i.e. there will be no results from which,
## except if there was an error.
which ft_disclaimer >/dev/null
which ft_main >/dev/null
which ft_m_0 >/dev/null
which ft_m_1 >/dev/null
which ft_m_2 >/dev/null
which ft_m_3 >/dev/null
which ft_m_4 >/dev/null
which ft_m_5 >/dev/null
which ft_m_6 >/dev/null
which ft_m_7 >/dev/null
which ft_m_8 >/dev/null

trap "" ERR
ft_disclaimer
returncode="$?"
trap "error_handler" ERR

if [ ! "$returncode" = 0 ]; then
   echo "You can always enter whonixsetup again, by starting: sudo whonixsetup"
   exit 0
fi

while [ 1 ]; do

   trap "" ERR
   ft_main
   returncode="$?"
   trap "error_handler" ERR

   ## if the cancel button gets pressed, returncode will be 0

   trap "" ERR
   ft_m_$returncode
   returncode_ft_m_x="$?"
   trap "error_handler" ERR

   if [ ! "$returncode_ft_m_x" = 0 ]; then
      break
   fi
done

echo "You can always enter whonixsetup again, by starting: sudo whonixsetup"

exit 0

