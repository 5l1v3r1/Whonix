#!/bin/bash

error_handler() {
   local MSG="\
###########################################################
## Something went wrong. Please report this bug!
##
## BASH_COMMAND: $BASH_COMMAND
###########################################################\
"
   echo "$MSG"
   exit 1
} 

trap "error_handler" ERR INT TERM

## root check
if [ "$(id -u)" != "0" ]; then
    echo "ERROR: This must be run as root (sudo)!"
    exit 1
fi

## sanity checks
which dialog
which ed
which service
if [ ! -e "/etc/tor/torrc" ]; then
   error "/etc/tor/torrc does not exist. Please report this bug!"
   exit 1
fi

MSG="
Tor tries to prevent attackers from learning what destination websites you connect to. However, by default, it does not prevent somebody watching your Internet traffic from learning that you are using Tor. If this matters to you, you can reduce this risk by configuring Tor to use a Tor bridge relay rather than connecting directly to the public Tor network. Ultimately the best protection is a social approach: the more Tor users there are near you and the more diverse their interests, the less dangerous it will be that you are one of them. Convince other people to use Tor, too!

Enable Tor and connect to the public Tor network?
"

TITLE="Connect to the public Tor network."

trap "" ERR INT TERM
dialog --title "$TITLE" --yesno "$MSG" 640 480
returncode=$?
trap "error_handler" ERR INT TERM

if [ ! "$returncode" = "0" ]; then
   ## Back to main menu.
   whonixsetup
   exit 0
fi

## Check if Tor was already enabled.
## This is to prevent getting ed from failing.
while read LINE; do
   if [ "$LINE" = '#DisableNetwork 1' ]; then
      service tor reload 
      dialog --title "Success!" --msgbox '"DisableNetwork 1" was already commented out in /etc/tor/torrc.
So Tor should now be activated.

whonixsetup really only activates Tor by commenting out "DisableNetwork 1" in /etc/tor/torrc.
Running it multiple times in a row archives nothing.
In case of network problems, this is probable not the cause.
You can confirm that by manually checking if "DisableNetwork 1" has been out commented in /etc/tor/torrc.
' 640 480
      exit 0
   fi
done < "/etc/tor/torrc"

## Comment out DisableNetwork 1 in /etc/tor/torrc
ed -s /etc/tor/torrc <<< $',s/DisableNetwork 1/#DisableNetwork 1/g\nw'

service tor reload

MSG="
Tor has been activated.
"

TITLE="Success!"

trap "" ERR INT TERM
dialog --title "$TITLE" --msgbox "$MSG" 640 480
trap "error_handler" ERR INT TERM

exit 0

