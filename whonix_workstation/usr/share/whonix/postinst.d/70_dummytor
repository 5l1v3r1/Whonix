#!/bin/bash

# This file is part of Whonix
# Copyright (C) 2012 - 2013 adrelanos <adrelanos at riseup dot net>
# See the file COPYING for copying conditions.

source /usr/share/whonix/postinst.d/pre.bsh

## dummytor

## Sanity test.
command -v readlink

## The DPKG_MAINTSCRIPT_PACKAGE related hack is documented in the 70_uwt
## postinst.d script.
DPKG_MAINTSCRIPT_PACKAGE_BACKUP="$DPKG_MAINTSCRIPT_PACKAGE"

if [ "$(readlink "/usr/bin/tor")" = "/usr/lib/whonix/dummytor" ]; then
   unlink /usr/bin/tor
fi

if [ "$(readlink "/usr/sbin/tor")" = "/usr/lib/whonix/dummytor" ]; then
   unlink /usr/sbin/tor
fi

unset DPKG_MAINTSCRIPT_PACKAGE
dpkg-divert --rename --remove /usr/sbin/tor || true
export DPKG_MAINTSCRIPT_PACKAGE="$DPKG_MAINTSCRIPT_PACKAGE_BACKUP"

dpkg-divert --add --rename --divert /usr/sbin/tor.real /usr/sbin/tor

unset DPKG_MAINTSCRIPT_PACKAGE
dpkg-divert --rename --remove /usr/bin/tor || true
export DPKG_MAINTSCRIPT_PACKAGE="$DPKG_MAINTSCRIPT_PACKAGE_BACKUP"

dpkg-divert --add --rename --divert /usr/bin/tor.real /usr/bin/tor

ln -s /usr/lib/whonix/dummytor /usr/bin/tor
ln -s /usr/lib/whonix/dummytor /usr/sbin/tor
