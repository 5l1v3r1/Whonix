#!/bin/bash

# This file is part of Whonix
# Copyright (C) 2012 - 2013 adrelanos <adrelanos at riseup dot net>
# See the file COPYING for copying conditions.

set -x

error_handler() {
   echo "
###########################################################
## chroot script: ERROR detected. Please report this bug! #
###########################################################
"

   exit 1
}

trap "error_handler" ERR

own_filename="$(basename $0)"
case $WHONIX_BUILD_SKIP_SCRIPTS in
   *$own_filename*) true "INFO: Skipping $own_filename, because WHONIX_BUILD_SKIP_SCRIPTS includes it."
                    exit 0
                    ;;
esac

echo "INFO: Cleaning up..."

## Kill dhclient3 to prevent rewrite of /var/lib/dhcp/*.
killall dhclient3 || true
## There are .leases.
rm /var/lib/dhcp/*.leases || true
## And there are .lease.
rm /var/lib/dhcp/*.lease || true
## We are best of deleting the whole folder.
rm -r /var/lib/dhcp/* || true

## Cleanup.
apt-get --yes autoremove --purge

## Get rid of /var/cache/apt/pkgcache.bin. (non-deterministic)
apt-get --yes clean

## No longer deleting /var/lib/tor. We install but forbid to run software such as Tor we install.
## Therefore /var/lib/tor should be empty.
## Ensure to delete /var/lib/tor. It contains sensitive stuff like the Tor consensus and the Tor entry guards.
## rm -r /var/lib/tor/* || true

## Delete logs and other stuff.
rm -r /tmp/* || true
rm /var/log/installer/* || true
rm -r /var/cache/apt/* || true
rm -r /var/lib/apt/lists/* || true
rm -r /var/log/installer || true
rm /var/lib/dpkg/*-old || true
rm /var/cache/debconf/*-old || true
## Erase rotated logs (usually wont appear unless you left your VM running for several days).
rm /var/log/*.[0-9] || true
rm /var/log/*.[0-9].gz || true

## Get rid of /var/lib/dpkg/available. (non-deterministic)
dpkg --clear-avail

## non-deterministic
rm -r -f /var/cache/fontconfig
rm -f /var/cache/ldconfig/aux-cache
rm -r -f /var/cache/man
rm -r -f /var/lib/xml-core
rm -f /usr/share/info/dir
rm -f /usr/share/info/dir.old ## no regeneration, since not required

## TODO:

## /etc/xml/
## /usr/lib/i386-linux-gnu/gdk-pixbuf-2.0/2.10.0/loaders.cache
## /usr/lib/i386-linux-gnu/gio/modules/giomodule.cache

## /usr/share/doc/whonix-*/changelog.Debian.gz
## /var/lib/dpkg/info/whonix-*.md5sums

## /usr/lib/i386-linux-gnu/gtk-2.0/2.10.0/immodules.cache
## /usr/lib/i386-linux-gnu/gtk-3.0/3.0.0/immodules.cache

## /usr/lib/pymodules/python2.7/hachoir_parser/common/__init__.pyc

## /usr/lib/pymodules/python2.7/numpy/core/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/f2py_ext/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/f2py_ext/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/f2py_f90_ext/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/f2py_f90_ext/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/gen_ext/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/gen_ext/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/pyrex_ext/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/pyrex_ext/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/swig_ext/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/distutils/tests/swig_ext/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/fft/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/lib/benchmarks/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/lib/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/linalg/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/ma/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/matrixlib/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/oldnumeric/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/polynomial/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/random/tests/__init__.pyc
## /usr/lib/pymodules/python2.7/numpy/testing/tests/__init__.pyc

## /var/lib/gconf/defaults/%gconf-tree.xml

## /var/lib/sgml-base/supercatalog
## /var/lib/sgml-base/supercatalog.old

## Truncate all log files, keeping user groups and permissions.
find /var/log -type f -exec cp /dev/null {} \;

## This will not work in chroot.
## Take care of development leaks and make resulting ova image smaller.
## Since VBox export works below the FS level it will keep deleted files (and the ova will stay large).
## This also ensure that possible leaks we deleted before are really deleted.
#echo "INFO: Wiping free space. This can take a while."
## TODO CHROOT #dd if=/dev/zero of=/zerofile bs=1024 || true

## Flush the zero-file to disk before removing it.
sync

## Delete the zero-file.
rm /zerofile || true

## Flush again after rm.
sync

## Delete bash history.
rm /home/"$USERNAME"/.bash_history || true
history -c || true

sync
