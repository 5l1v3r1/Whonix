#!/bin/bash

## Whonix /usr/local/bin/$SCRIPTNAME uwt wrapper.

## If you want to enable/disable uwt and/or privacy
## globally or for certain applications, see /etc/whonix.d/.

## Debugging.
#set -x

trap "error_handler" ERR

SCRIPTNAME="$(basename $0)"

error_handler() {
echo "
## uwtwrapper BUG.
## SCRIPTNAME: $SCRIPTNAME
## BASH_COMMAND: $BASH_COMMAND
## Please report this BUG!
"
exit 1
}

## sanity tests
if [ ! -e /usr/local/bin/uwt ]; then
   echo "$SCRIPTNAME uwt wrapper ERROR: /usr/local/bin/uwt does not exist."
   exit 1
fi
if [ ! -x /usr/local/bin/uwt ]; then
   echo "$SCRIPTNAME uwt wrapper ERROR: /usr/local/bin/uwt is not executable."
   exit 1
fi
if [ ! -e /usr/bin/"$SCRIPTNAME" ]; then
   echo "$SCRIPTNAME uwt wrapper ERROR: /usr/bin/"$SCRIPTNAME" does not exist."
   exit 1
fi
if [ ! -x /usr/bin/"$SCRIPTNAME" ]; then
   echo "$SCRIPTNAME uwt wrapper ERROR: /usr/bin/"$SCRIPTNAME" is not executable."
   exit 1
fi

## Files in /etc/whonix.d/* set variables such as
## port_aptget, port_gpg, ... and variables such as
## timeprivacy_aptget, timeprivacy_gpg, ... and variables such as
## uwtwrapper_aptget, uwtwrapper_gpg, ... and ip.
for i in /etc/whonix.d/*; do
   if [ -f "$i" ]; then
      ## If the last character is a ~, ignore that file, because it was created
      ## by some editor, which creates backup files.
      if [ "{$i: -1}" = "~" ]; then
         continue
      fi
      source "$i"
   fi
done

## Since application names sometimes contains "-" and bash variables
## may not include "-", we have to remove "-" from the script name.
SCRIPTNAME_CLEANED="$(echo $SCRIPTNAME | sed 's/-//g')"

temp="uwtport_"$SCRIPTNAME_CLEANED""
port="${!temp}"

temp="timeprivacy_"$SCRIPTNAME""

if [ "${!temp}" = "1" ]; then
   fake_time="faketime"
   privacy_time="$(timeprivacy -f /tmp/timeprivacy_"$SCRIPTNAME_CLEANED")"
else
   if [ "$timeprivacy_global" = "1" ]; then
      fake_time="faketime"
      privacy_time="$(timeprivacy)"
   else
      fake_time=""
      privacy_time=""
   fi
fi

## Using "|| { ret=$? ; true; };" to prevent involking error_handler in case
## the executed application retured a non-zero value.

if [ "$uwtwrapper_global" = "0" ]; then
   if [ "$fake_time" = "faketime" ]; then
      "$fake_time" "$privacy_time" /usr/bin/"$SCRIPTNAME" ${1+"$@"} || { ret=$? ; true; };
   else
      /usr/bin/"$SCRIPTNAME" ${1+"$@"} || { ret=$? ; true; };
   fi
   exit $ret
fi

temp="uwtwrapper_"$SCRIPTNAME_CLEANED""

if [ "${!temp}" = "0" ]; then
   if [ "$fake_time" = "faketime" ]; then
      "$fake_time" "$privacy_time" /usr/bin/"$SCRIPTNAME" ${1+"$@"} || { ret=$? ; true; };
   else
      /usr/bin/"$SCRIPTNAME" ${1+"$@"} || { ret=$? ; true; };
   fi
   exit $ret
fi

if [ "$fake_time" = "faketime" ]; then
   "$fake_time" "$privacy_time" /usr/local/bin/uwt -t 5 -i "$ip" -p "$port" /usr/bin/"$SCRIPTNAME" ${1+"$@"} || { ret=$? ; true; };
else
   /usr/local/bin/uwt -t 5 -i "$ip" -p "$port" /usr/bin/"$SCRIPTNAME" ${1+"$@"} || { ret=$? ; true; };
fi
exit $ret

## End of Whonix /usr/local/bin/$SCRIPTNAME uwt wrapper.
