check_htpdate() {
  trap "error_handler" ERR INT TERM

  local pid_file="/var/run/htpdate/pid"
  local done_file="/var/run/htpdate/done"
  local success_file="/var/run/htpdate/success"

  ## Thanks to:
  ## http://unix.stackexchange.com/questions/12068/how-to-measure-time-of-program-execution-and-store-that-inside-a-variable

  TIME_END="`date +%s`"
  TIME_DIFF="`expr "$TIME_END" - "$TIME_START"`" || true
  WAIT_MIN="60"

  #echo "check_htpdate debug info: expr $WAIT_MIN - $TIME_DIFF"
  WAIT_RESULT="`expr "$WAIT_MIN" - "$TIME_DIFF"`" || true
  #echo "check_htpdate debug info: WAIT_RESULT: $WAIT_RESULT"

  if [ ! -f "$pid_file" ]; then
    local MSG='Network Time Synchronization failed!!! pid_file does not exist. Please report this bug!
See logfile: tail -f -n 20 /var/log/htpdate.log
See status files: cd /var/run/htpdate && dir
Try again: Start menu -> Applications -> System -> Whonix Timesync
           or in Terminal: timesync
Last resort: manually set the clock! (In UTC!):
             sudo su
             date -s "17 FEB 2012 24:00:00" && hwclock -w'
    echo "$MSG"
    #echo "System clock is set to: `date`"
    output "--error" "ERROR" "$MSG"
    return
  fi

  if [ -f "$success_file" ]; then
     local SUCCESS_TIME="`date -r "$success_file"`" 
     local MSG="Last run (on "$SUCCESS_TIME") of Network Time Synchronization (timesync) successful."
     echo "$MSG"
     #echo "System clock is set to: `date`"
     output "--info" "Info" "$MSG"
     return
  fi
  
  if [ -f "$done_file" ]; then
    ## Done but no success. This should rarely happen. Only in case the internet connection
    ## was done at this point. We checked internet connection some moments ago.
    local MSG='Network Time Synchronization done but no success!!! Please report this bug!
See logfile: tail -f -n 20 /var/log/htpdate.log
See status files: cd /var/run/htpdate && dir
Try again: Start menu -> Applications -> System -> Whonix Timesync
           or in Terminal: timesync
Last resort: manually set the clock! (In UTC!):
             sudo su
             date -s "17 FEB 2012 24:00:00" && hwclock -w'
    echo "$MSG"
    #echo "System clock is set to: `date`"
    output "--error" "ERROR" "$MSG"
    return
  fi
  
  #echo "check_htpdate debug info: WAIT_RESULT: $WAIT_RESULT"

  if [ $WAIT_RESULT -gt 0 ]; then
    #echo "check_htpdate debug info: Not done. Waiting up to $WAIT_RESULT more seconds."
    sleep 5
    check_htpdate
    return
  fi

  local MSG='Network Time Synchronization failed!!!
See logfile: tail -f -n 20 /var/log/htpdate.log
See status files: cd /var/run/htpdate && dir
Try again: Start menu -> Applications -> System -> Whonix Timesync
           or in Terminal: timesync
Last resort: manually set the clock! (In UTC!):
             sudo su
             date -s "17 FEB 2012 24:00:00" && hwclock -w'
  echo "$MSG"
  #echo "System clock is set to: `date`"
  output "--error" "ERROR" "$MSG"
  return
} 

