#!/bin/bash

## Whonix /usr/local/bin/whonixcheck_login

## This script gets run by:
## - /etc/profile.d/whonixcheck.sh
## - /home/user/.config/autostart/whonixcheck.desktop

## Random delay between 0 and 500 seconds.
DELAY="$(( 100+(`od -An -N2 -i /dev/random` )%(300-0+1) ))"

## 60 seconds minimum delay.
DELAY="`expr "$DELAY" + "60"`" || true

## For debugging.
#DELAY="10"

MSG="whonixcheck checks were recently completed. No need to run all checks again already.

You could still start whonixcheck manually."

source /usr/local/bin/whonixcheck-scripts/20_check-lastrun
check_whonixcheck_lastrun

if [ "$WHONIXCHECK_RECENTLY_RUN" = 0 ]; then
   echo "Running whonixcheck in "$DELAY" seconds..."

   if [ -f "/usr/local/share/whonix/whonix_workstation" ]; then
      notify-send --expire-time ""$DELAY"000" "whonixcheck" "Running whonixcheck in "$DELAY" seconds." || true
   fi

   sleep "$DELAY"

   whonixcheck -autostart
else
   echo "$MSG"

   if [ -f "/usr/local/share/whonix/whonix_workstation" ]; then
      notify-send --expire-time ""$DELAY"000" "whonixcheck" "$MSG" || true
   fi

   exit 0
fi

## notify-send will fade out in max. 10 seconds due to an upstream bug:
##    https://bugs.launchpad.net/ubuntu/+source/notify-osd/+bug/390508
## Using || true in case notify-send is not installed.
## --expire-time expects milliseconds, hence adding 000.

## End of Whonix /usr/local/bin/whonixcheck_login
