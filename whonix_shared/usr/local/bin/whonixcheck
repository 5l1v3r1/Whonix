#!/bin/bash

## If anyone adds a VPN or something similar to Whonix-Workstation
## (i.e. connection scheme: Whonix-Workstation -> Tor -> VPN), he would wonder
## why it is not detected.

#set -x

NOTIFY_MSG="Checking Tor Connection, Tor Browser Version, Operating System Updates, Whonix Version, Whonix News, Status of Time Synchronization...
This will happen in background and will take approximately three minutes."

SCRIPTNAME="`basename $0`"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source "$MYDIR"/whonixcheck-scripts/help_error-handler
source "$MYDIR"/whonixcheck-scripts/help_output
source "$MYDIR"/whonixcheck-scripts/10_preparation
source "$MYDIR"/whonixcheck-scripts/help_cli
source "$MYDIR"/whonixcheck-scripts/help_phrase-cmd-options
source "$MYDIR"/whonixcheck-scripts/15_kill-old-instances
source "$MYDIR"/whonixcheck-scripts/20_check-lastrun
source "$MYDIR"/whonixcheck-scripts/25_autostart
source "$MYDIR"/whonixcheck-scripts/30_welcome
source "$MYDIR"/whonixcheck-scripts/35_disclaimer
source "$MYDIR"/whonixcheck-scripts/40_check-tor
source "$MYDIR"/whonixcheck-scripts/45_check-stream-isolation
source "$MYDIR"/whonixcheck-scripts/50_check-whonix-news
source "$MYDIR"/whonixcheck-scripts/55_check-operating-system
source "$MYDIR"/whonixcheck-scripts/60_download-whonix-blog
source "$MYDIR"/whonixcheck-scripts/help_tbbversion
source "$MYDIR"/whonixcheck-scripts/65_check-torbrowser
source "$MYDIR"/whonixcheck-scripts/67_check_clock
source "$MYDIR"/whonixcheck-scripts/70_check-htpdate
source "$MYDIR"/whonixcheck-scripts/75_cleanup

whonixcheck_main() {
  trap "error_handler" ERR INT TERM

  preparation ## 10_preparation
  phrase_cmd_options $1 ## help_phrase-cmd-options
  kill_old_instances ## 15_kill-old-instances
  check_whonixcheck_lastrun ## 20_check-lastrun
  check_autostart ## 25_autostart
  progress_bar ## help_output
  welcome ## 30_welcome
  disclaimer ## 35_disclaimer

  ## The 5% indicate, that the check has begun.
  progress_bar 5

  if [ -f "/usr/local/share/whonix/whonix_workstation" ]; then
    ## for Whonix-Workstation

    ## connection 1
    check_tor "SocksPort" ## 40_check-tor
    progress_bar 15

    ## connection 2
    check_tor "TransPort" ## 40_check-tor
    progress_bar 30

    ## no connection
    check_stream_isolation ## 45_check-stream-isolation

    ## connection 3
    ## after checking IPs
    ## early in list, because less likely to break
    download_whonix_news ## 50_check-whonix-news
    verify_whonix_news  ## 50_check-whonix-news
    check_whonix_version  ## 50_check-whonix-news
    check_whonix_news  ## 50_check-whonix-news
    progress_bar 45

    ## connection 4
    check_operating_system ## 55_check-operating-system
    progress_bar 60

    ## connection 5
    download_important_blog ## 60_download-whonix-blog
    progress_bar 75

    ## connection 7
    download_feature_blog ## 60_download-whonix-blog
    progress_bar 90

    ## connection 4
    check_torbrowser ## 65_check-torbrowser
    progress_bar 95

    ## no connection
    check_bootclockrandomization

    ## no connection
    check_timesanitycheck

    ## no connection
    ## last, more time to finish
    check_htpdate ## 70_check-htpdate

  else
    ## for Whonix-Gateway

    ## connection 1
    check_tor "SocksPort"

    ## connection 2
    ## after checking IP
    ## early in list, because less likely to break
    download_whonix_news
    verify_whonix_news
    check_whonix_version
    check_whonix_news

    ## connection 3
    check_operating_system

    ## no connection
    check_bootclockrandomization

    ## no connection
    check_timesanitycheck

    ## no connection
    ## last, more time to finish
    check_htpdate
  fi

  whonixcheck_completed ## 20_check-lastrun

  progress_bar 100
  show_output ## help_output
  cleanup ## 75_cleanup

  exit 0
}

whonixcheck_main $1

## End of whonixcheck script.
