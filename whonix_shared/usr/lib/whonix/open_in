#!/bin/bash

# This file is part of Whonix
# Copyright (C) 2012 - 2013 adrelanos <adrelanos at riseup dot net>
# See the file COPYING for copying conditions.

set -x

main_function() {

   if [ -f "${1+"$@"}" ]; then
      local is_file="1"
   else
      local is_file="0"
   fi

   ## For simulating a Whonix-Gateway, comment in the next line and comment out the over next one.
   #if [ true ]; then

   if [ -f "/usr/share/whonix/whonix_gateway" ]; then
      local icon="/usr/share/whonix/icons/whonix.ico"

      if [ ! "$EDITOR" = "" ]; then
         local open_in_tool_bin="$EDITOR"
         local open_in_tool_bin_pretty_name="\$EDITOR $EDITOR"
      ## What other useful condition could we check to determine the default editor?
      elif [ "1" = "2" ]; then
         local open_in_tool_bin="?"
         local open_in_tool_bin_pretty_name="?"
      else
         local open_in_tool_bin="kwrite"
         local open_in_tool_bin_pretty_name="KWrite"
      fi

      local open_in_tool_extra_opts=""

      if [ $is_file = "1" ]; then
         local title="Whonix File Open Confirmation"
         local msg="${1+"$@"} will be opened in $open_in_tool_bin_pretty_name. Continue?"
      else
         local title="Whonix ERROR"
         local msg="Whonix does not support opening links on Whonix-Gateway for security reasons."
         zenity --title="$title" --error --window-icon "$icon" --text "$msg"
         exit 0
      fi

   elif [ -f "/usr/share/whonix/whonix_workstation" ]; then
      local icon="/usr/share/whonix/icons/tbupdate.ico"
      local open_in_tool_bin="torbrowser"
      local open_in_tool_bin_pretty_name="Tor Browser"
      local open_in_tool_extra_opts="--new-window"
      local title="Whonix Tor Browser"
      local msg="${1+"$@"} will be opened in $open_in_tool_bin_pretty_name. Continue?

Be careful if $open_in_tool_bin_pretty_name is already running as your activities might get linked.
"
   else
      local icon="/usr/share/whonix/icons/whonix.ico"
      local title="Whonix ERROR"
      local msg="ERROR $0 script could not determine if this is whonix_gateway or whonix_workstation. Please report this bug."
      echo "$msg"
      zenity --title="$title" --error --window-icon "$icon" --text "$msg"
      exit 1
   fi

   local answer="0"
   zenity --title="$title" --question --window-icon "$icon" --text "$msg" >/dev/null 2>/dev/null || { local answer="$?" ; true; };

   if [ "$answer" = "1" ]; then
      exit 0
   fi

   local which_return="0"
   which $open_in_tool_bin >/dev/null 2>/dev/null || { local which_return="$?" ; true; };

   if [ ! "$which_return" = "0" ]; then
      local msg="ERROR: $open_in_tool_bin does not exist! Please report this bug!"
      zenity --title="$title" --error --window-icon "$icon" --text "$msg"
      exit 1
   fi

   local open_in_tool_return="0"
   $open_in_tool_bin $open_in_tool_extra_opts ${1+"$@"} || { local open_in_tool_return="$?" ; true; };

   if [ ! "$open_in_tool_return" = "0" ]; then
      local msg="ERROR: $open_in_tool_bin returned $open_in_tool_return! Please report this bug!"
      zenity --title="$title" --error --window-icon "$icon" --text "$msg"
   fi

   exit "$open_in_tool_return"
}

main_function ${1+"$@"}
