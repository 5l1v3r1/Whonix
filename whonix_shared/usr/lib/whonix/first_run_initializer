#!/bin/bash

## This file is part of Whonix.
## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

set -x
set -o pipefail

## NOTE:
## /usr/share/whonix/postinst.d/70_legacy prevents this script from getting run
## on older versions not supporting the verifiable builds feature.

error_handler() {
   ## Debugging.
   true "WARNING: exited with non-zero exit code: $?"
}

trap "error_handler" ERR

if [ "$(id -u)" != "0" ]; then
    echo "ERROR: This must be run as root (sudo)!"
    exit 1
else
    true "INFO: Script running as root."
fi

export DEBIAN_FRONTEND="noninteractive"

## {{{ /var/lib/whonix/initial-packages

shopt -s nullglob dotglob

for file_name in "/var/lib/whonix/initial-packages/"*; do
   ## Example file_name:
   ## /var/lib/whonix/initial-packages/nano_2.2.6-1+b1_i386.deb
   file_basename="$(basename "$file_name")"
   ## Example file_name:
   ## nano_2.2.6-1+b1_i386.deb
   package="$(echo "$file_basename" | tr "_" " " | awk '{print $1}')"
   ## Example package:
   ## nano
   dpkg_status="$(dpkg-query --show --showformat='${db:Status-Abbrev}' "$package")"
   ## Example dpkg_status:
   ## ii
   status_second_char="${dpkg_status:1:1}"
   ## Example status_second_char:
   ## i
   if [ "$status_second_char" = "i" ]; then
      ## Installed. Reinstall...
      true "INFO: Reinstalling $package ($file_name)..."
      dpkg --install "$file_name"
   else
      ## Not installed. Skipping.
      true "INFO: $package ($file_name) not installed, skipping."
   fi
done

shopt -u nullglob dotglob

## }}}

## non-deterministic [14]
## /etc/init.d/.depend.boot
## /etc/init.d/.depend.start
## /etc/init.d/.depend.stop
if [ -x /sbin/insserv ]; then
   /sbin/insserv --showall
   /sbin/insserv --verbose
fi

## non-deterministic [17]
## /etc/apt/trustdb.gpg
## Thanks to:
## https://unix.stackexchange.com/questions/110500/how-to-regenerate-etc-apt-trustdb-gpg-on-debian
## This is no longer required for Debian Jessie?
apt-key update

dpkg --configure -a

## exit 0 would not be required, but that makes it easier to check the last
## command in the log using a script.
exit 0
