#!/bin/bash

# This file is part of Whonix
# Copyright (C) 2012 - 2013 adrelanos <adrelanos at riseup dot net>
# See the file COPYING for copying conditions.

## Debugging
#set -x

set -o pipefail

## Debugging
export PATH="$PATH:/home/user/whonix_dot/Whonix/whonix_shared/usr/lib/whonix/whonixsetup/"
export PATH="$PATH:/home/user/whonix_dot/Whonix/whonix_shared/usr/bin/"
export PATH="$PATH:/usr/lib/whonix/whonixsetup/"

error_handler() {
   local MSG="\
###########################################################
## Something went wrong. Please report this bug!
##
## BASH_COMMAND: $BASH_COMMAND
###########################################################\
"
   echo "$MSG"
   exit 1
}

trap "error_handler" ERR

SCRIPTNAME="$(basename $0)"

if [ "$(id -u)" != "0" ]; then
    echo "ERROR: This must be run as root (sudo)!"
    echo "INFO: You can start $SCRIPTNAME by entering..."
    echo "      sudo $SCRIPTNAME"
    exit 1
fi

## sanity tests
## >/dev/null hides stdout, but not stderr,
## i.e. there will be no results from command -v,
## except if there was an error.
command -v whonix_repository >/dev/null
command -v ft_disclaimer >/dev/null
command -v ft_main >/dev/null
command -v ft_m_0 >/dev/null
command -v ft_m_1 >/dev/null
command -v ft_m_2 >/dev/null
command -v ft_m_3 >/dev/null
command -v ft_m_4 >/dev/null
command -v ft_m_5 >/dev/null
command -v ft_m_6 >/dev/null
command -v ft_m_7 >/dev/null
command -v ft_m_8 >/dev/null

command -v dialog >/dev/null
command -v ed >/dev/null
command -v service >/dev/null

if [ ! -e "/etc/tor/torrc" ]; then
   error "/etc/tor/torrc does not exist. Please report this bug!"
   exit 1
fi

returncode="0"
ft_disclaimer || { returncode="$?" ; true; };

if [ ! "$returncode" = "0" ]; then
   echo "You can always enter whonixsetup again, by starting: sudo whonixsetup"
   exit 0
fi

## /usr/lib/whonix/shortcuts/whonix-autosetup will not start whonixcheck, if
## /root/.whonix.d/35_aptrepository_autogenerated exists. So we won't
## needlessly always start the whonix_repository tool.

echo "Starting Whonix Repository Tool..."
whonix_repository
echo "End of Whonix Repository Tool."

## Do not start Whonix Connection Wizard on Whonix-Workstation.
if [ -f "/usr/share/whonix/whonix_workstation" ]; then
   echo "You can always enter whonixsetup again, by starting: sudo whonixsetup"
   exit 0
fi

while true; do
   returncode="0"
   ft_main || { returncode="$?" ; true; };

   ## if the cancel button gets pressed, returncode will be 0

   returncode_ft_m_x="0"
   "ft_m_$returncode" || { returncode_ft_m_x="$?" ; true; };

   if [ ! "$returncode_ft_m_x" = "0" ]; then
      break
   fi
done

echo "You can always enter whonixsetup again, by starting: sudo whonixsetup"

exit 0
