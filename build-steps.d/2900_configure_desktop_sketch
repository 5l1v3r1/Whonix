#!/bin/bash

## Copyright (C) 2019 - 2019 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

CHROOT_DIRECTORY="/home/user/whonix-desktop/chroot"
RAW_DIRECTORY="/home/user/whonix-desktop"


copy-vm-files(){
   ## here we copy the Gateway and Workstation .qcow2 files into the host VM
   ## previously I ran qemu-img convert -f qcow2 -O qcow2 on the host to reduce their size
   ## a final, clean build step should also take care of building/extracting/shrinking these files automatically
   ## of course it would also use variables instead of version numbers
   ## we also apply correct file permissions

   cp --sparse=always $RAW_DIRECTORY/Whonix-Gateway.qcow2 $CHROOT_DIRECTORY/var/lib/libvirt/images/Whonix-Gateway.qcow2
   cp --sparse=always $RAW_DIRECTORY/Whonix-Workstation.qcow2 $CHROOT_DIRECTORY/var/lib/libvirt/images/Whonix-Workstation.qcow2

   chroot $CHROOT_DIRECTORY chmod -v -R 444 var/lib/libvirt/images/Whonix-Gateway.qcow2
   chroot $CHROOT_DIRECTORY chmod -v -R 444 var/lib/libvirt/images/Whonix-Workstation.qcow2
   chroot $CHROOT_DIRECTORY chown -v -R libvirt-qemu:libvirt-qemu var/lib/libvirt/images/Whonix-Gateway.qcow2
   chroot $CHROOT_DIRECTORY chown -v -R libvirt-qemu:libvirt-qemu var/lib/libvirt/images/Whonix-Workstation.qcow2
}


config-calamares(){
   ## some modifications to the default debian Calamares settings
   ## - only adding new users to libvirt and qemu groups by default
   ## - removing live-boot and calamares related packages (it seems necessary to remove live-boot to make the target
   ##   system bootable - needs more testing)
   ## - we also enable the installer to set a password for the root account (? not sure about this one)
   ## much more customization can be done, and may be necessary (for instance branding)

cat <<'EOF'> $CHROOT_DIRECTORY/etc/calamares/modules/packages.conf

backend: apt

operations:
   - remove:
      - 'live-boot'
      - 'live-boot-doc'
      - 'live-config'
      - 'live-config-doc'
      - 'live-config-systemd'
      - 'live-config-systemd'
      - 'live-tools'
      - 'live-task-localisation'
      - 'calamares'
      - 'calamares-settings-debian'
EOF


   cat <<'EOF'> $CHROOT_DIRECTORY/etc/calamares/modules/users.conf

---
userGroup: users
defaultGroups:
- libvirt
- qemu
autologinGroup: autologin
sudoersGroup: sudo
setRootPassword: true

EOF
}

clean-vm() {
   chroot $CHROOT_DIRECTORY mkdir /var/log/tor
   chroot $CHROOT_DIRECTORY chown -R debian-tor:adm /var/log/tor
}
