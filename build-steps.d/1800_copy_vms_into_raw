#!/bin/bash

## Copyright (C) 2019 - 2019 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.




copy-vm-files(){
   ## here we copy the Gateway and Workstation .qcow2 files into the host VM
   ## previously I ran qemu-img convert -f qcow2 -O qcow2 on the host to reduce their size
   ## a final, clean build step should also take care of building/extracting/shrinking these files automatically
   ## of course it would also use variables instead of version numbers
   ## we also apply correct file permissions

   cp --sparse=always $RAW_DIRECTORY/Whonix-Gateway.qcow2 $CHROOT_DIRECTORY/var/lib/libvirt/images/Whonix-Gateway.qcow2
   cp --sparse=always $RAW_DIRECTORY/Whonix-Workstation.qcow2 $CHROOT_DIRECTORY/var/lib/libvirt/images/Whonix-Workstation.qcow2

   chroot $CHROOT_DIRECTORY chmod -v -R 444 var/lib/libvirt/images/Whonix-Gateway.qcow2
   chroot $CHROOT_DIRECTORY chmod -v -R 444 var/lib/libvirt/images/Whonix-Workstation.qcow2
   chroot $CHROOT_DIRECTORY chown -v -R libvirt-qemu:libvirt-qemu var/lib/libvirt/images/Whonix-Gateway.qcow2
   chroot $CHROOT_DIRECTORY chown -v -R libvirt-qemu:libvirt-qemu var/lib/libvirt/images/Whonix-Workstation.qcow2
}
