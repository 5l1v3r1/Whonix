#!/bin/bash
# build script: /home/user/whonix/whonix_getiso

# See LICENSE in root of Whonix source for copyright, license and authors.

script_help() {
echo "
# Download and verify the iso or delete the iso.
#
#-download
#-delete
#
# (-delete untested)
"
}

# Enable debugging.
set -x

######################################################
# Variables
######################################################
# Set the linux username.
# "export USERNAME=$(whoami)" will not work, since the
# script gets, in most cases, started as root.
USERNAME="user"

# change to home dir so relative paths work correctly
cd /home/$USERNAME

whonix_getiso_general_error() {
   echo "
############################################
# whonix_getiso ERROR !!!                     #
# BASH_COMMAND: $BASH_COMMAND
############################################
"
   exit 1
}

whonix_getiso_gpg_error() {
   echo "
############################################
# whonix_getiso gpg verification failed !!!   #
############################################
"
   DOWNLOADFAILED="1"
   touch /home/$USERNAME/whonix_binary/WHONIX_BUILD_FAILED
   exit 1
}

root_check() {
######################################################
# Checking script environment
######################################################
# Check if we are root
  if [ "$(id -u)" != "0" ]; then
       echo "ERROR: This must be run as root (sudo)!"
       exit 1
  else
       echo "INFO: Script running as root."
  fi
}

download_verify_iso() {
trap "whonix_getiso_general_error" ERR

sudo -u $USERNAME mkdir -p /home/$USERNAME/whonix_binary

sudo -u $USERNAME wget -c "http://www.ubuntu.com/start-download?distro=server&bits=32&release=lts" --output-document /home/$USERNAME/whonix_binary/ubuntu-12.04-server-i386.iso

#For Debian Squeeze
#sudo -u $USERNAME wget -c "http://ftp.funet.fi/pub/linux/mirrors/debian-cdimage/6.0.5/i386/iso-cd/debian-6.0.5-i386-CD-1.iso" --output-document ...!!!...

sudo -u $USERNAME wget -c http://releases.ubuntu.com/12.04/SHA256SUMS --output-document /home/$USERNAME/whonix_binary/SHA256SUMS

sudo -u $USERNAME wget -c http://releases.ubuntu.com/12.04/SHA256SUMS.gpg --output-document /home/$USERNAME/whonix_binary/SHA256SUMS.gpg

sudo -u $USERNAME rm -r /home/$USERNAME/whonix_binary/gpgtmpdir || true
sudo -u $USERNAME mkdir -p /home/$USERNAME/whonix_binary/gpgtmpdir
sudo -u $USERNAME chmod 700 /home/$USERNAME/whonix_binary/gpgtmpdir

# Import GPG key on Ubuntu.
sudo -u $USERNAME gpg --homedir /home/$USERNAME/whonix_binary/gpgtmpdir --import /etc/apt/trusted.gpg

# If you do not use Ubuntu:
# Source of that fingerprint is above trusted.gpg file, I couldn't find a TLS encrypted source of it anywhere.
# gpg --homedir gpgtmpdir --keyserver subkeys.pgp.net --recv-keys C5986B4F1257FFA86632CBA746181433FBB75451

trap "whonix_getiso_gpg_error" ERR

# Verify that SHA256SUMS file is signed by Ubuntu.
sudo -u $USERNAME gpg --homedir /home/$USERNAME/whonix_binary/gpgtmpdir --verify /home/$USERNAME/whonix_binary/SHA256SUMS.gpg /home/$USERNAME/whonix_binary/SHA256SUMS

trap "whonix_getiso_general_error" ERR

echo "INFO: Successfully gpg verified SHA256SUMS."
DOWNLOADFAILED="0"

cd /home/$USERNAME/whonix_binary/

sudo -u $USERNAME sha256sum -c /home/$USERNAME/whonix_binary/SHA256SUMS | grep "ubuntu-12.04-server-i386.iso: OK" || DOWNLOADFAILED="1"

cd /home/$USERNAME/

if [ "$DOWNLOADFAILED" = "1" ]; then
   echo "FATAL ERROR: Download Failed!"
   touch /home/$USERNAME/whonix_binary/WHONIX_BUILD_FAILED
   exit 1
fi

echo "INFO: Successfully downloaded and verified iso."
exit 0
}

delete_iso() {
rm /home/$USERNAME/whonix_binary/SHA256SUMS || true
rm /home/$USERNAME/whonix_binary/SHA256SUMS.gpg || true
rm /home/$USERNAME/whonix_binary/ubuntu-12.04-server-i386.iso || true
echo "Done."
}

################################################################ 
# -dowload                                                     #
################################################################ 
if [[ "$1" = "-download" ]]; then
   root_check
   download_verify_iso
   echo "BUILD INFO: Done, if success, next stept should be sudo ./whonix_modifyiso -tg-create"
   exit 0
fi

################################################################ 
# -delete                                                      #
################################################################ 
if [[ "$1" = "-delete" ]]; then
   root_check
   delete_iso
   exit 0
fi



################################################################ 
# -help                                                        #
################################################################ 
if [[ "$1" = "-help" ]]; then
   script_help
   exit 0
fi



################################################################ 
# no option chosen                                             #
################################################################ 
echo "No option choosen. Use -help for help."
touch /home/$USERNAME/whonix_binary/WHONIX_BUILD_FAILED || true
exit 1