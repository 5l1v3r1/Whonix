#!/bin/bash

set -x

true "Currently running script: $0"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source variables
source pre

error_handler_run-chroot-scripts() {
   echo "ERROR in $0. Aborting..."
   ./unchroot-img
   ./unprevent-daemons-from-starting   
   ./unmount-img   
   echo "ERROR in $0! Aborted."
   exit 1
}

run-chroot-scripts() {
   trap "error_handler_run-chroot-scripts" ERR INT TERM

   sync

   ## Ignored on bare-metal.
   ./mount-img
   
   ./prevent-daemons-from-starting
   
   ## Ignored on bare-metal.
   ./chroot-img

   sync

   ## Just for testing.
   $CHROOT update-grub -v
   $CHROOT sync
   sync

   ## We need to copy the pre chroot scripts manually into the image,
   ## because the *-common packages are not yet installed at this point.
   
   cp \
     "$WHONIX_SOURCE_FOLDER"/whonix_shared/usr/share/whonix/chroot-scripts-pre.d/* \
     "$CHROOT_FOLDER"/var/lib/whonix/initial-chroot-scripts-pre.d/
     
   if [ "$MACHINE" = "-tg" ] || [ "$MACHINE" = "-tg-bare-metal" ]; then   
      cp \
        "$WHONIX_SOURCE_FOLDER"/whonix_gateway/usr/share/whonix/chroot-scripts-pre.d/* \
        "$CHROOT_FOLDER"/var/lib/whonix/initial-chroot-scripts-pre.d/ 
   fi
   
   if [ "$MACHINE" = "-tw" ] || [ "$MACHINE" = "-tw-bare-metal" ]; then   
      cp \
        "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/share/whonix/chroot-scripts-pre.d/* \
        "$CHROOT_FOLDER"/var/lib/whonix/initial-chroot-scripts-pre.d/
   fi  
   
   ## Check which chroot scripts we got.
   $CHROOT run-parts --verbose --test "/var/lib/whonix/initial-chroot-scripts-pre.d"

   ## Run the chroot scripts.
   ## (Which got copied into the image by copyinto.)
   $CHROOT run-parts --verbose --exit-on-error "/var/lib/whonix/initial-chroot-scripts-pre.d"

   sync

   ## Ignored on bare-metal.
   ./unchroot-img
   
   ./unprevent-daemons-from-starting   
   
   ## Ignored on bare-metal.   
   ./unmount-img

   sync
}

run-chroot-scripts

