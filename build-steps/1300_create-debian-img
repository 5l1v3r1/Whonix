#!/bin/bash

set -x

true "Currently running script: $0"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source variables
source pre

create-debian-img() {
   trap "error_handler_general" ERR INT TERM

   mkdir --parents "$WHONIX_BINARY"/
   chown --recursive "$USERNAME":"$USERNAME" "$WHONIX_BINARY"/

   ## If whonix_build is run with -fast switch.
   if [ "$FAST" = "1" ]; then
      echo "create-debian-img: run with -fast switch. Skipping image creation step."
      exit 0
   fi

   ## vmsize 100 GB does not matter because only space,
   ## which gets actually filled up, will take disk space.

   if [ -z "$WHONIX_TARGET_ARCH" ]; then
      ## Default architecture.
      export WHONIX_TARGET_ARCH="i386"
   fi
   if [ "$WHONIX_TARGET_ARCH" = "" ]; then
      ## Default architecture.
      export WHONIX_TARGET_ARCH="i386"
   fi

   true "INFO: WHONIX_TARGET_ARCH: $WHONIX_TARGET_ARCH"

   ## Enable apt-cacher-ng proxy.
   export http_proxy="http://127.0.0.1:3142"   
   
   grml-debootstrap \
      --arch "$WHONIX_TARGET_ARCH" \
      --filesystem ext4 \
      --force \
      --hostname host \
      --keep_src_list \
      --password changeme \
      --release wheezy \
      --verbose \
      --vmfile \
      --vmsize "100G" \
      --config ""$WHONIX_SOURCE_FOLDER"/grml_config" \
      --packages ""$WHONIX_SOURCE_FOLDER"/grml_packages" \
      --target "$WHONIX_BINARY"/"$VMNAME".img
      
   ## Disable apt-cacher-ng proxy.
   export unset http_proxy      

   chown --recursive "$USERNAME":"$USERNAME" "$WHONIX_BINARY"/
} 

create-debian-img

