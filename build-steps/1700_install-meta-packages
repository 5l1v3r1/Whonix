#!/bin/bash

set -x

true "Currently running script: $0"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source variables
source pre

install-meta-packages() {
   trap "error_handler_general" ERR INT TERM

   sync

   ./mount-img
   ./prevent-daemons-from-starting
   ./chroot-img

   sync

   ## Just for testing.
   $CHROOT update-grub -v
   $CHROOT sync
   sync
   
   $CHROOT gdebi --non-interactive "$DEB_INSTALL_FOLDER"/whonix-shared_"$VERSION"_all.deb
   $CHROOT gdebi --non-interactive "$DEB_INSTALL_FOLDER"/whonix-shared-desktop_"$VERSION"_all.deb
   $CHROOT gdebi --non-interactive "$DEB_INSTALL_FOLDER"/whonix-shared-desktop-kde_"$VERSION"_all.deb
   $CHROOT gdebi --non-interactive "$DEB_INSTALL_FOLDER"/whonix-shared-kde-accessibility_"$VERSION"_all.deb
   
   sync
   
   if [ "$MACHINE" = "-tg" ] || [ "$MACHINE" = "-tg-bare-metal" ]; then 
      $CHROOT gdebi --non-interactive "$DEB_INSTALL_FOLDER"/whonix-gateway_"$VERSION"_all.deb
   elif [ "$MACHINE" = "-tw" ] || [ "$MACHINE" = "-tw-bare-metal" ]; then
      $CHROOT gdebi --non-interactive "$DEB_INSTALL_FOLDER"/whonix-workstation_"$VERSION"_all.deb
      $CHROOT gdebi --non-interactive "$DEB_INSTALL_FOLDER"/whonix-workstation-default-applications_"$VERSION"_all.deb
   else
      bug "ERROR: MACHINE is $MACHINE - neither -tg nor -tg-bare-metal nor -tw nor tw-bare-metal"
   fi   
   
   sync

   ./unchroot-img
   ./unprevent-daemons-from-starting   
   ./unmount-img

   sync
}

install-meta-packages

 
