#!/bin/bash

set -x

true "Currently running script: $0"

TEMP_SCRIPTNAME="$0"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source variables
source pre

install-postinst-d-packages() {
   trap "error_handler_unchroot_unprevent_unmount" ERR INT TERM

   sync

   ./mount-img   
   ./prevent-daemons-from-starting   
   ./chroot-img

   sync

   ## Just for testing.
   $CHROOT update-grub -v
   $CHROOT sync
   sync

   ## Enable apt-cacher-ng.
   export http_proxy="http://127.0.0.1:3142"   
   
   mkdir --parents "$WHONIX_INITIAL_DEB_INSTALL_FOLDER"
   mkdir --parents "$CHROOT_FOLDER"/"$EMPTY_DIR"
   mount --bind "$WHONIX_APT_REPOSITORY_FOLDER" "$WHONIX_INITIAL_DEB_INSTALL_FOLDER"
   
   echo "deb file:$DEB_INSTALL_FOLDER/ stable main" > "$WHONIX_SOURCES_LIST_TEMP_BUILD_FULL"
   
   $CHROOT sudo apt-get update \
                   -o Dir::Etc::sourcelist="$WHONIX_SOURCES_LIST_TEMP_BUILD_BASE" \
                   -o Dir::Etc::sourceparts="$EMPTY_DIR" \
                   -o APT::Get::List-Cleanup="0"   

   sync   
   
   if [ "$MACHINE" = "-tg" ] || [ "$MACHINE" = "-tg-bare-metal" ]; then
      $CHROOT apt-get --yes install whonix-gateway-postinst
   elif [ "$MACHINE" = "-tw" ] || [ "$MACHINE" = "-tw-bare-metal" ]; then
      $CHROOT apt-get --yes install whonix-workstation-postinst
   else
      bug "ERROR: MACHINE is $MACHINE - neither -tg nor -tg-bare-metal nor -tw nor tw-bare-metal"
   fi
   
   $CHROOT rm --force "$WHONIX_SOURCES_LIST_TEMP_BUILD_FULL"
   
   $CHROOT apt-get update \
              --no-download \
              --list-cleanup

   $CHROOT sync   
   sync
   
   umount "$WHONIX_INITIAL_DEB_INSTALL_FOLDER"   
   
   ## Disable apt-cacher-ng.
   export unset http_proxy   

   ./unchroot-img   
   ./unprevent-daemons-from-starting   
   ./unmount-img

   sync
}

install-postinst-d-packages


 
