#!/bin/bash
## internally used by whonix_createvm

set -x

copy_backup_workstation() {
   trap "error_handler_int_whonix_image" ERR INT TERM

   ## /etc/polipo/config
   ## not installing polipo by default
   cp --no-clobber --recursive --preserve "$CHROOT_FOLDER"/whonix_workstation/etc/polipo/config "$CHROOT_FOLDER"/etc/polipo/config.backup || true

   ## /etc/kde4/kdm/kdmrc
   ## Overriding with true because its only for kde autologin for the case kde does not get installed in custom builds.
   cp --no-clobber --recursive --preserve "$CHROOT_FOLDER"/etc/kde4/kdm/kdmrc "$CHROOT_FOLDER"/etc/kde4/kdm/kdmrc.backup || true
}

copy_into_workstation() {
   trap "error_handler_int_whonix_image" ERR INT TERM

   ## /etc/resolv.conf
   ## We do not need chattr +i for Whonix-W resolv.conf, because
   ## DHCP is never used and resolvconf was uninstalled.

   ## /home/user/Desktop symlinks get created by
   ## "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/whonix_internal_install_script

   ## copy skel to user home is done in int_copy_shared

   ## Copy
   rsync --verbose --perms --recursive --checksum "$WHONIX_SOURCE_FOLDER"/whonix_workstation/ "$CHROOT_FOLDER"/

   ## Fix permissions for /home/user/.
   mkdir -p "$CHROOT_FOLDER"/home/user/
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/
}
