#!/bin/bash
# internally used by whonix_createvm

set -x

copy_workstation_pre() {
   ############
   ## restore #
   ############

   cp --recursive --preserve "$CHROOT_FOLDER"/whonix_workstation/etc/polipo/config.backup "$CHROOT_FOLDER"/whonix_workstation/etc/polipo/config || true

   # /etc/kde4/kdm/kdmrc
   # Overriding with true because its only for kde autologin for the case kde does not get installed in custom builds.
   cp --recursive --preserve "$CHROOT_FOLDER"/etc/kde4/kdm/kdmrc.backup "$CHROOT_FOLDER"/etc/kde4/kdm/kdmrc || true

   ###########
   ## backup #
   ###########

   cp --no-clobber --recursive --preserve "$CHROOT_FOLDER"/whonix_workstation/etc/polipo/config "$CHROOT_FOLDER"/whonix_workstation/etc/polipo/config.backup

   # /etc/kde4/kdm/kdmrc
   # Overriding with true because its only for kde autologin for the case kde does not get installed in custom builds.
   cp --no-clobber --recursive --preserve "$CHROOT_FOLDER"/etc/kde4/kdm/kdmrc "$CHROOT_FOLDER"/etc/kde4/kdm/kdmrc.backup || true

   ###############################
   # Whonix-Workstation Copy Pre #
   ###############################

   # Copy VM script into VM image and make it executable.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/whonix_internal_install_script \
"$CHROOT_FOLDER"/usr/local/share/whonix/whonix_internal_install_script
   chmod --recursive +x "$CHROOT_FOLDER"/usr/local/share/whonix/whonix_internal_install_script

   # Copy Whonix helpfile into VM.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/bin/whonix "$CHROOT_FOLDER"/usr/local/bin/whonix
   chmod --recursive +x "$CHROOT_FOLDER"/usr/local/bin/whonix

   # /usr/local/bin/hiddenserver-install
   # TODO DOC
   # TODO Needs documentation, revision, gui, menu integration.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/bin/hiddenserver-install "$CHROOT_FOLDER"/usr/local/bin/hiddenserver-install
   chmod --recursive +x "$CHROOT_FOLDER"/usr/local/bin/hiddenserver-install

   # Copy the torbrowser update script.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/bin/torbrowser "$CHROOT_FOLDER"/usr/local/bin/torbrowser
   chmod --recursive +x "$CHROOT_FOLDER"/usr/local/bin/torbrowser

   # Just a marker that it is a whonix_workstation. Used by whonixcheck script.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/whonix_workstation "$CHROOT_FOLDER"/usr/local/share/whonix/whonix_workstation

   # /etc/network/interfaces
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/etc/network/interfaces "$CHROOT_FOLDER"/etc/network/interfaces

   # firewall script
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/bin/whonix_firewall "$CHROOT_FOLDER"/usr/local/bin/whonix_firewall
   chmod --recursive +x "$CHROOT_FOLDER"/usr/local/bin/whonix_firewall

   # polipo
   mkdir -p "$CHROOT_FOLDER"/whonix_workstation/etc/
   mkdir -p "$CHROOT_FOLDER"/whonix_workstation/etc/polipo/
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/etc/polipo/config "$CHROOT_FOLDER"/etc/polipo/

   # wpolipo whonix polipo wrapper for multiple http listen ports and multiple socks parent proxies
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/etc/init.d/wpolipo "$CHROOT_FOLDER"/etc/init.d/wpolipo
   chmod --recursive +x "$CHROOT_FOLDER"/etc/init.d/wpolipo

   # apt conf 99whonix
   mkdir -p /etc/apt/apt.conf.d
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/etc/apt/apt.conf.d/99whonix "$CHROOT_FOLDER"/etc/apt/apt.conf.d/

   # start-tor-browser
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/start-tor-browser \
"$CHROOT_FOLDER"/usr/local/share/whonix/start-tor-browser

   # /etc/environment
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/etc/environment "$CHROOT_FOLDER"/etc/

      ############
      # leaktest #
      ############

   # Create the leaktest folder.
   mkdir -p "$CHROOT_FOLDER"/usr/local/share/whonix/leaktest

   # /usr/local/share/whonix/leaktest/simple_ping.py
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/leaktest/simple_ping.py \
"$CHROOT_FOLDER"/usr/local/share/whonix/leaktest/simple_ping.py

   # /usr/local/share/whonix/leaktest/exhaustive_ip_send.py
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/leaktest/exhaustive_ip_send.py \
"$CHROOT_FOLDER"/usr/local/share/whonix/leaktest/exhaustive_ip_send.py

   # /usr/local/share/whonix/leaktest/tcp_test.py
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/leaktest/tcp_test.py \
"$CHROOT_FOLDER"/usr/local/share/whonix/leaktest/tcp_test.py

   # /usr/local/share/whonix/leaktest/udp_test.py
   cp "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/leaktest/udp_test.py \
"$CHROOT_FOLDER"/usr/local/share/whonix/leaktest/udp_test.py

   # /usr/local/bin/leaktest
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/bin/leaktest \
"$CHROOT_FOLDER"/usr/local/bin/leaktest
   chmod --recursive +x "$CHROOT_FOLDER"/usr/local/bin/leaktest

      #########
      # xchat #
      #########

   # Prepare /usr/local/share/whonix/xchat2 folder.
   mkdir -p "$CHROOT_FOLDER"/usr/local/share/whonix/
   chown --recursive user:user "$CHROOT_FOLDER"/usr/local/share/whonix/
   mkdir -p "$CHROOT_FOLDER"/usr/local/share/whonix/xchat2
   chown --recursive user:user "$CHROOT_FOLDER"/usr/local/share/whonix/xchat2

   # Copy xchat configuration files.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/xchat2 "$CHROOT_FOLDER"/usr/local/share/whonix/

   # /usr/local/bin/xchat-reset
   # TODO: Needs documentation, warning, gui, menu integration.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/bin/xchat-reset "$CHROOT_FOLDER"/usr/local/bin/xchat-reset
   chmod --recursive +x "$CHROOT_FOLDER"/usr/local/bin/xchat-reset

      ########
      # skel #
      ########

   #cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/etc/skel/ "$CHROOT_FOLDER"/etc/skel/

      ###########
      # desktop #
      ###########

   mkdir -p "$CHROOT_FOLDER"/home/
   # no chown...

   mkdir -p "$CHROOT_FOLDER"/home/user/
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/

   mkdir -p "$CHROOT_FOLDER"/home/user/.local/share/
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/.local/share/

   mkdir -p "$CHROOT_FOLDER"/home/user/Desktop
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/Desktop

   mkdir -p "$CHROOT_FOLDER"/home/user/.config/autostart
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/.config/autostart

   # kde settings files
   mkdir -p "$CHROOT_FOLDER"/usr/local/share/whonix/
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/kde "$CHROOT_FOLDER"/usr/local/share/whonix/
   chmod --recursive +x "$CHROOT_FOLDER"/usr/local/share/whonix/kde/share/applications/*

      #########################
      # whonixcheck autostart #
      #########################

   # .config/autostart/whonixcheck.desktop
   # ~/.config/autostart is a freedesktop.org standard and should work cross desktop.
   # Create whonixcheck autostart.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/home/user/.config/autostart/whonixcheck.desktop \
"$CHROOT_FOLDER"/home/user/.config/autostart/whonixcheck.desktop
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/.config/autostart/whonixcheck.desktop

   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/home/user/whonixcheck_info "$CHROOT_FOLDER"/home/user/whonixcheck_info

      #################
      # Desktop Icons #
      #################

   # symlinks is created by
   # "$WHONIX_SOURCE_FOLDER"/whonix_workstation/usr/local/share/whonix/whonix_internal_install_script

      ######################
      # mixmaster remailer #
      ######################

   mkdir -p "$CHROOT_FOLDER"/home/user/.Mix
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/.Mix

   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/home/user/.Mix/mix.cfg "$CHROOT_FOLDER"/home/user/.Mix/mix.cfg
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/.Mix/mix.cfg

      ##########
      # rawdog #
      ##########

   mkdir -p "$CHROOT_FOLDER"/home/user/.rawdog
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/.rawdog

   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/home/user/.rawdog/* "$CHROOT_FOLDER"/home/user/.rawdog/
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/.rawdog
}

append_workstation_pre() {
   ##################################
   # Whonix-Workstation Append Pre  #
   ##################################

   # /etc/sysctl.conf
   # IPv6 off, Forwarding off, fs.file-max to 100000, vm.swappiness to 0
   while read LINE; do
      echo $LINE >> "$CHROOT_FOLDER"/etc/sysctl.conf
   done < "$WHONIX_SOURCE_FOLDER"/whonix_workstation/etc/appendto_sysctl.conf

   # /etc/kde4/kdm/kdmrc
   # Overriding with true because its only for kde autologin for the case kde does not get installed in custom builds.
   while read LINE; do
      echo $LINE >> "$CHROOT_FOLDER"/etc/kde4/kdm/kdmrc
   done < "$WHONIX_SOURCE_FOLDER"/whonix_workstation/etc/kde4/kdm/appendto_kdmrc || true
}

copy_workstation_post() {
   ################################
   # Whonix-Workstation Copy Post #
   ################################

   # /etc/resolv.conf
   # We do not need chattr +i for Whonix-W resolv.conf, because
   # dhcp is never used and resolvconf was uninstalled.
   cp --recursive --preserve "$WHONIX_SOURCE_FOLDER"/whonix_workstation/etc/resolv.conf "$CHROOT_FOLDER"/etc/resolv.conf

   # /home/user/Desktop/*
   # post, because whonix_internal_install_script creates symlinks
   chmod --recursive +x /home/user/Desktop/*
}

append_workstation_post() {
   ##################################
   # Whonix-Workstation Append Post #
   ##################################

      ###########
      # .bashrc #
      ###########

   while read LINE; do
      echo $LINE >> "$CHROOT_FOLDER"/home/user/.bashrc
   done < "$WHONIX_SOURCE_FOLDER"/whonix_workstation/home/user/.bashrc
   chown --recursive user:user "$CHROOT_FOLDER"/home/user/.bashrc
}