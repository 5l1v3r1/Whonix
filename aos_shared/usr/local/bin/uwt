#! /bin/sh

# Update 11

# ***************************************************************************
# *                                                                         *
# *   Copyright (C) 2008-2011 Robert Hogan <robert@roberthogan.net>         *
# *                                                                         *
# *   This program is free software; you can redistribute it and/or modify  *
# *   it under the terms of the GNU General Public License as published by  *
# *   the Free Software Foundation; either version 2 of the License, or     *
# *   (at your option) any later version.                                   *
# *                                                                         *
# *   This program is distributed in the hope that it will be useful,       *
# *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
# *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
# *   GNU General Public License for more details.                          *
# *                                                                         *
# *   You should have received a copy of the GNU General Public License     *
# *   along with this program; if not, write to the                         *
# *   Free Software Foundation, Inc.,                                       *
#*   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
# ***************************************************************************
# *                                                                         *
# *   This is a modified version of a source file from the Tor project.     *
# *   Original copyright notice from tsocks source file follows:            *
# ***************************************************************************

# Wrapper script for use of the tsocks(8) transparent socksification library
# See the tsocks(1) and torify(1) manpages.

# Copyright (c) 2004, 2006 Peter Palfrader
# Modified by Jacob Appelbaum <jacob@appelbaum.net> April 16th 2006
# Modified by Marcus Griep <marcus@griep.us> June 16 2009
# May be distributed under the same terms as Tor itself

# Note:
# -v (verbose) and the UWT_VERBOSE environment variable set to 1
# will break many graphical applications, which use applications,
# which will call applications, which we wrapped to use uwt.

# You can also type in shell:
# 	export UWT_VERBOSE="1"
# to enable verbose output.
# Note: When running applications as root, you also have to set and
#       export that variable as root.

# Define and ensure we have tsocks
# XXX: what if we do not have which?
TORSOCKS="`which torsocks`"
PROG=
VERBOSE=

usage () {
	echo "Usage: $0 [-h] [-v] [ <command> [<options>...]"
}

set_id () {
	echo "ERROR: $1 is set${2}id. usewithtor will not work on a set${2}id executable." >&2
	exit 1
}

# Check for any argument list
if [ "$#" = 0 ]; then
	usage >&2
	exit 1
fi

# TODO:
# IP and PORTS can be set below.

while [ "$1" ]; do
	case "$1" in
		-h|--h*)
			usage
			exit 0
			;;
		-v|--v*)
			VERBOSE=YesPlease
			shift
			;;
		*)
			break;
	esac
done

exe="`which $1`"
if [ "$exe" = "" ]; then
	echo "UWT ERROR: $1 does not exist!" >&2
	exit 1
fi

if [ -u `which "$1"` ]; then
	set_id $1 u
elif [ -g `which "$1"` ]; then
	set_id $1 g
fi

if [ -x "$TORSOCKS" ]; then
	PROG=torsocks
else
	echo "$0: Unable to find torsocks in PATH." >&2
	echo "    Perhaps you have not installed it?" >&2
	exit 1
fi

if [ "$VERBOSE" ]; then
	echo "We are armed with the following torsocks: $TORSOCKS"
	echo "We are attempting to use $PROG for all tor action."
fi

if [ "$PROG" = "torsocks" ]; then
	# Define our torsocks config file.
        TORSOCKS_CONF_FILE="/tmp/$(whoami)_torsocks_temp"
	export TORSOCKS_CONF_FILE
	#echo "TORSOCKS_CONF_FILE: $TORSOCKS_CONF_FILE"

	echo "
		# Temporary torsocks configuration file created by uwt.
		# Safe to delete.
		local = 127.0.0.0/255.128.0.0
		local = 127.128.0.0/255.192.0.0
		local = 169.254.0.0/255.255.0.0
		local = 172.16.0.0/255.240.0.0
		local = 192.168.0.0/255.255.0.0
		server = $ip
		server_type = 5
		server_port = $port
	" > $TORSOCKS_CONF_FILE

	# Check that we have got a torsocks config file
	if [ -r "$TORSOCKS_CONF_FILE" ]; then
		# echo "1 UWT_VERBOSE: $UWT_VERBOSE"

		if [ -z $UWT_VERBOSE ]; then
			# echo "UWT_VERBOSE: did not exist."
			UWT_VERBOSE=0
		else
			if [ $UWT_VERBOSE -eq "1" ]; then
				VERBOSE=YesPlease
			fi
		fi
		# echo "2 UWT_VERBOSE: $UWT_VERBOSE"
		if [ $VERBOSE ]; then
			echo "uwt"
			echo "ip: $ip port: $port"
		fi

                UWT_LOCALHOST="0"

                case "$*" in
                   *127.0.0.1*)
                      UWT_LOCALHOST="1"
                   ;;
                   *localhost*)
                      UWT_LOCALHOST="1"
                   ;;
                   *)
                      # do nothing
                      sleep 0
                   ;;
                esac

                if [ "$UWT_LOCALHOST" = "1" ]; then
                   if [ $VERBOSE ]; then
                      echo "UWT_LOCALHOST: $UWT_LOCALHOST NOT using torsocks."
  		      echo "exec torsocks \"$@\""
                   fi
                   exec "$@"
                else
                   if [ $VERBOSE ]; then
                      echo "UWT_LOCALHOST: $UWT_LOCALHOST USING torsocks."
  		      echo "exec torsocks \"$@\""
                   fi
                   exec torsocks "$@"
                fi
	else
		# Since identity corelation through circuit sharing is at risk,
		# we should no longer let torsocks default to 9050.
		echo "$0: Missing torsocks configuration file \"$TORSOCKS_CONF_FILE\."
		exit 1
	fi
fi

# We should have hit an exec. If we get here, we did not exec
echo "$0: failed to exec $PROG $@" >&2
exit 1
# End of uwt script.