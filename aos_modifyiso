#!/bin/bash
# Safe as /home/username/TorBOX_source/TorBOX_ModifyISO

# Version: TorBOX 0.2.1

# Copyright: proper
#
# License: GPL v3 or any later
#
# Any changes you pull changes into this source will be also licensed
# under GPL v3 or any later. Additionally you grant proper the right to
# re-license your work under a different license. If that is not acceptable,
# you can either fork this source under GPL v3 or any later or contact proper.
# Contact proper, if you require this source code under different license.

script_help() {
echo "
# TorBOX_ModifyISO available commands:
#
# -create
#  creates preseed.iso
#
# -delete
#  unmounts and deletes ISO and build folder
#
# -help
#  shows this help
"
}



# Enable debugging.
set -x

# Exit if there is an error
set -e

USERNAME="user"

# Thanks to
# http://askubuntu.com/questions/122505/how-do-i-create-completely-unattended-install-for-ubuntu



##############################################################################################
# error_handler
##############################################################################################
error_handler() {
echo "
#!!! ERROR in TorBOX_ModifyISO !!!#
#!!! ERROR in TorBOX_ModifyISO !!!#
#!!! ERROR in TorBOX_ModifyISO !!!#
"

echo "TorBOX_ModifyISO: unmounting iso..."
unmount_iso
echo "TorBOX_ModifyISO: Done."

touch /home/$USERNAME/TorBOX_binary/TORBOX_BUILD_FAILED
exit 1
}



root_check() {
######################################################
# Checking script environment
######################################################
# Check if we are root
  if [ "$(id -u)" != "0" ]; then
       echo "ERROR: This must be run as root (sudo)!"
       exit 1
  else
       echo "INFO: Script running as root."
  fi
}



##############################################################################################
# mount_and_copy_iso
##############################################################################################

mount_and_copy_iso() {
   trap "error_handler" ERR INT TERM

   mkdir -p /home/$USERNAME/TorBOX_binary/original_iso
   # Ubuntu:
   mount -o loop /home/$USERNAME/TorBOX_binary/ubuntu-12.04-server-i386.iso /home/$USERNAME/TorBOX_binary/original_iso
   # Debian:
   #mount -o loop /home/$USERNAME/TorBOX_binary/debian-6.0.5-i386-CD-1.iso /home/$USERNAME/TorBOX_binary/original_iso
   mkdir -p /home/$USERNAME/TorBOX_binary/modified_iso
   cp -rT /home/$USERNAME/TorBOX_binary/original_iso /home/$USERNAME/TorBOX_binary/modified_iso
}



##############################################################################################
# unmount_iso
##############################################################################################

unmount_iso() {
   umount /home/user/TorBOX_binary/original_iso
   rm -r /home/user/TorBOX_binary/original_iso
}



##############################################################################################
# modify_iso_general
##############################################################################################

modify_iso_general() {
trap "error_handler" ERR INT TERM

# This function...
# Is suboptimal, but it works.
#
# Please, if you make changes to this file, document your changes.
# Preseeding is not the most bugfree or easy thing.
# Changes my break it.
# If you make changes, please test if they are working!

#################################################################################
# lang
#################################################################################

echo en > /home/$USERNAME/TorBOX_binary/modified_iso/isolinux/lang

#################################################################################
# isolinux.cfg
#################################################################################

echo '
#Generated by TorBOX

default 1
prompt 1
timeout 5
label 1
# Ubuntu Precise
kernel /install/vmlinuz
append file=/cdrom/preseed/ubuntu-server.seed initrd=/install/initrd.gz ks=cdrom:/ks.cfg preseed/file=/cdrom/preseed.cfg --

# Or Debian Squeeze NOT WORKING YET
#kernel /install.386/vmlinuz
#append preseed/file=/cdrom/preseed.cfg initrd=/install.386/initrd.gz --
' > /home/$USERNAME/TorBOX_binary/modified_iso/isolinux/isolinux.cfg

#################################################################################
# ks.cfg
#################################################################################

# Create kickstart configuration file.
# Due to bugs in Ubuntu preseed we have to combine kickstart with preseed.
# Bugs such as choosing the language does not work with preseed alone.
echo '
#Generated by TorBOX

#Generated by Kickstart Configurator
#platform=x86

#System language
lang en_US
#Language modules to install
langsupport en_US
#System keyboard
keyboard us
#System mouse
mouse
#System timezone
timezone --utc America/New_York
#Root password
rootpw --disabled
#Initial user
user user --fullname "user" --iscrypted --password $1$FfTFybF6$FCXsl5qUXudXAapnGj2mB/
#Use text mode install
text
#Install OS instead of upgrade
install
#Use CDROM installation media
cdrom
#System bootloader configuration
bootloader --location=mbr 
#Clear the Master Boot Record
#zerombr yes
#Partition clearing information
#clearpart --all --initlabel 
#Disk partitioning information
#part / --fstype ext4 --size 1 --grow --asprimary 
#System authorization infomation
auth  --useshadow  --enablemd5 
#Firewall configuration
firewall --disabled 
#Do not configure the X Window System
skipx
' > /home/$USERNAME/TorBOX_binary/modified_iso/ks.cfg

#################################################################################
# preseed.cfg
#################################################################################

# Comment (proper):
#   This file could look better. As soon as we move to file separeated source,
#   we can keep more comments.
#
# Note:
#   "" and $$ must be escaped!
#
# Thanks to:
#   http://ubuntuforums.org/showthread.php?t=1145188

echo "
### Misc
d-i hw-detect/load_firmware boolean true
d-i pkgsel/install-language-support	boolean false
d-i debian-installer/quiet	boolean false
d-i debian-installer/splash	boolean false
d-i pkgsel/update-policy select none
d-i popularity-contest popularity-contest/participate boolean false

### Network settings
#d-i netcfg/no_interfaces boolean true
#d-i netcfg/enable boolean false
#d-i netcfg/dhcp_failed note
#d-i netcfg/disable_dhcp boolean true
#d-i netcfg/dhcp_options select \"Do not configure the network at this time\"
#d-i netcfg/choose_interface select eth1
#
# This is a workaround.
# Only one network adapter attached while installing with preseed.
# The network cable is NOT attached.
# We still need to configure the network manually to *something*,
# due to limitations in upstream preseed netcfg.
# ("Do not configure network at this time" does not work.)
#
d-i netcfg/dhcp_failed note
d-i netcfg/disable_dhcp boolean true
d-i netcfg/dhcp_options select Configure network manually
d-i netcfg/get_nameservers string 192.168.0.1
d-i netcfg/get_ipaddress string 192.168.0.2
d-i netcfg/get_netmask string 255.255.255.0
d-i netcfg/get_gateway string 192.168.0.1
d-i netcfg/confirm_static boolean true

### Localization
# Preseeding only locale sets language, country and locale.
d-i debian-installer/country string US
d-i debian-installer/language string en
d-i debian-installer/locale string en_US.UTF-8

### Keyboard selection.
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/layoutcode string us
#d-i keyboard-configuration/variantcode string dvorak

### Mirror settings
#d-i mirror/protocol string ftp
#d-i mirror/country string manual
#d-i mirror/http/hostname string archive.ubuntu.com
#d-i mirror/http/directory string /ubuntu
#d-i mirror/http/proxy string

### Apt settings
d-i apt-setup/use_mirror boolean false

### Clock settings
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean false
#d-i clock-setup/ntp-server string ntp.example.com

### Partitioning
d-i partman-auto/init_automatically_partition select biggest_free
d-i partman-auto/method string regular
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true

# Thanks to https://bugs.launchpad.net/omsk/+bug/551947/comments/3
d-i partman-basicfilesystems/no_swap boolean false

# First example in partman-auto-recipe.txt without swap.
d-i partman-auto/expert_recipe string                         \
partman-auto/text/atomic_scheme :: \
500 10000 1000000 ext4 \
$primary{ } \
$bootable{ } \
method{ format } \
format{ } \
use_filesystem{ } \
filesystem{ ext4 } \
mountpoint{ / } .

d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

### Base system installation
d-i base-installer/install-recommends boolean false
#d-i base-installer/kernel/image string linux-generic

### Account setup
#d-i passwd/root-login boolean false
#d-i passwd/make-user boolean false
d-i passwd/user-fullname string user
d-i passwd/username string user
d-i passwd/user-password password changeme
d-i passwd/user-password-again password changeme
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

### Grub
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/timeout	string 2

### Finishing up the installation
d-i finish-install/reboot_in_progress note
d-i debian-installer/exit/poweroff boolean true

### X configuration
xserver-xorg xserver-xorg/config/device/driver select vesa
xserver-xorg xserver-xorg/autodetect_mouse boolean true
xserver-xorg xserver-xorg/autodetect_monitor boolean true
xserver-xorg xserver-xorg/config/monitor/selection-method \
       select medium
xserver-xorg xserver-xorg/config/monitor/mode-list \
       select 1024x768 @ 60 Hz

" > /home/$USERNAME/TorBOX_binary/modified_iso/preseed.cfg
}



##############################################################################################
# rebuild_iso
##############################################################################################

rebuild_iso() {
trap "error_handler" ERR INT TERM

mkisofs -D -r -V "ATTENDLESS_UBUNTU" -cache-inodes -J -l -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -o /home/$USERNAME/TorBOX_binary/$ISO_NAME /home/$USERNAME/TorBOX_binary/modified_iso/
}



################################################################ 
# -create                                                      #
################################################################ 
if [[ "$1" = "-create" ]]; then
   root_check
   mount_and_copy_iso
   unmount_iso
   modify_iso_general
   ISO_NAME="preseed.iso"
   rebuild_iso
   echo "BUILD INFO: Done, if success, next stept should be sudo ./TorBOX_CreateVM -tg-pre"
   exit 0
fi



################################################################ 
# -delete                                                      #
################################################################ 
if [[ "$1" = "-delete" ]]; then
   root_check
   unmount_iso
   rm -r /home/$USERNAME/TorBOX_binary/modified_iso
   rm /home/$USERNAME/TorBOX_binary/preseed.iso
   echo "Done."
   exit 0
fi



################################################################ 
# -help                                                        #
################################################################ 
if [[ "$1" = "-help" ]]; then
   script_help
   exit 0
fi



################################################################ 
# no option chosen                                             #
################################################################ 
echo "No option choosen. Use -help for help."
touch /home/$USERNAME/TorBOX_binary/TORBOX_BUILD_FAILED
exit 1
