#!/usr/bin/make -f

SOURCEFOLDERS=whonix_shared whonix_gateway whonix_workstation

# Generally exclude files matching the regular expression,
# NOTE: if the excluded file(s) result in an empty directory, this
#       directory is also excluded at all
#
# EXCLUDE=.*\(\.directory\)\|.*\(\.bashrc\)\|.*\(timesync\.desktop\)
INITFILES=\(etc\/init\.d\/.*\)
DEFAULTFILES=\(etc\/default\/.*\)
EXCLUDE=.*\(\(\.directory\)\|$(DEFAULTFILES)\|$(INITFILES)

#export DH_VERBOSE=1

clean:
	dh_testdir
	dh_testroot
	dh_clean
	-rm -f $(CURDIR)/debian/*.init
	-rm -f $(CURDIR)/debian/*.default
	-rm -f $(CURDIR)/debian/*.manpages

build-arch: build

build-indep: build
	
build: 

binary: binary-indep

binary-arch:

binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installman
	dh_installdebconf
	dh_installchangelogs
	dh_installdocs
	dh_gencontrol
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_md5sums
	dh_builddeb
	
install: build
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs

	@mkdir -p $(CURDIR)/debian/tmp
	@for sf in $(SOURCEFOLDERS); do \
		find $$sf/ -not -regex '$(EXCLUDE)\)$$' -type f -exec cp -p --parents {} \
			$(CURDIR)/debian/tmp \; ; \
		case "$$sf" in \
			"whonix_shared") \
			for dm in `find $$sf/ -regex '.*\($(DEFAULTFILES)\)' -type f \
				-printf '$(CURDIR)/%p;$(CURDIR)/debian/whonix-shared-common.%f.default '`; do \
				cp -p `echo $$dm | sed -e 's/;/ /g'` ; \
			done ; \
			for im in `find $$sf/ -regex '.*\($(INITFILES)\)' -type f \
				-printf '$(CURDIR)/%p;$(CURDIR)/debian/whonix-shared-common.%f.init '`; do \
				cp -p `echo $$im | sed -e 's/;/ /g'` ; \
			done ; \
			for in in `find $$sf/ -regex '.*\($(INITFILES)\)' -type f -printf '%f '`; do \
				echo "dh_installinit -pwhonix-shared-common --name=$$in"; \
				dh_installinit -pwhonix-shared-common --name=$$in; \
			done ; \
			;; \
		esac ; \
	done
	
	@for sf in $(SOURCEFOLDERS); do \
		for ronn in `find $(CURDIR)/man/$$sf/ -name '*.ronn'`; do \
			SEC=`gawk '/^.*\([1-9]\) --/ { match($$0, /^.*\(([1-9])\) --/, m); print m[1] }' $$ronn` ; \
			DEST=`echo "$(CURDIR)/debian/tmp/$$sf/usr/share/man/man$$SEC/"` ; \
			DEST=$$DEST`basename $$ronn .ronn` ; \
			DEST=$$DEST"."$$SEC ; \
			mkdir -p `dirname $$DEST` ; \
			ronn --manual="Whonix Documentation" --organization="Whonix" --pipe -r $$ronn > $$DEST; \
			case "$$sf" in \
				"whonix_gateway") \
					echo $$DEST >> $(CURDIR)/debian/whonix-gateway-common.manpages ; \
					;; \
				"whonix_shared") \
					echo $$DEST >> $(CURDIR)/debian/whonix-shared-common.manpages ; \
					;; \
				"whonix_workstation") \
					echo $$DEST >> $(CURDIR)/debian/whonix-workstation-common.manpages ; \
					;; \
			esac ; \
		done ; \
	done

	@if [ ! -f $(CURDIR)/debian/copyright ]; then \
		cp $(CURDIR)/LICENSE $(CURDIR)/debian/copyright; \
	fi
	
	dh_install --fail-missing --sourcedir=$(CURDIR)/debian/tmp
	
.PHONY: build clean binary install
