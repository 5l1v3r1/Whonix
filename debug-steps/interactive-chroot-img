#!/bin/bash

set -x

true "Currently running script: $0"

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd help-steps

source pre
source variables

error_handler_interactive-chroot-img-shell() {
   trap "error_handler_interactive-img" ERR INT TERM

   echo "${green}INFO${reset}: Exited (1) interactive shell."
   sync
}

error_handler_interactive-chroot-img() {
   echo "
${red}${bold}BASH_COMMAND${reset}: $BASH_COMMAND
${red}${bold}ERROR $0: | caller: $(caller)${reset}
Unchrooting.. Unpreventing daemons from starting... Unmounting img...
"

   ./unchroot-img
   ./unprevent-daemons-from-starting
   ./unmount-img
   
   echo "
${red}${bold}BASH_COMMAND${reset}: $BASH_COMMAND
${red}${bold}ERROR $0: | caller: $(caller)${reset}
"

   exit 1
}

interactive-chroot-img() {
   trap "error_handler_interactive-chroot-img" ERR INT TERM

   ./mount-img
   ./prevent-daemons-from-starting
   ./chroot-img

   sync

   ## Just for testing.
   $CHROOT mount
   $CHROOT update-grub -v
   sync

   ## Info.
   echo "${cyan}INFO${reset}: Entering interactive shell..."
   echo "${cyan}Recommendation${reset}: check /home/user if you are really inside the image and not on your host system."
   echo "    When you are done, do not forget to leave the shell using: exit 0"

   ## Run interactive shell.
   trap "error_handler_interactive-chroot-img-shell" ERR INT TERM
   $CHROOT "/bin/bash"

   echo "${green}INFO${reset}: Exited (0) interactive shell."

   ./unchroot-img
   ./unprevent-daemons-from-starting
   ./unmount-img

   sync
}

true "${bold}INFO: Currently running script: $0${reset}"
interactive-chroot-img

