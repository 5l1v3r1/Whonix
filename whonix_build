#!/bin/bash

set -x

true "$0"

cd help-steps

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source variables
source pre

cd ..

script_help() {
: "
# creates separate build folder
# FLAGS:
# -all
# build both Virtual machines
#
# -fast
# skips the -createimg step
#
# -tg
# Builds Whonix-Gateway VBox machine.
#
# -tw
# Builds Whonix-Workstation VBox machine.
#
# -clean
# deletes .img and Virtual Box vms
"
}



chmod +x "$WHONIX_SOURCE_FOLDER"/build-steps/20_create-debian-img



error_handler_build-machine() {
: echo "
#!!! ERROR in `caller` !!!#
#!!! ERROR in `caller` !!!#
#!!! ERROR in `caller` !!!#
"

chmod +x "$WHONIX_SOURCE_FOLDER"/build-steps/20_create-debian-img

exit 1
}



whonix_build_machine() {
	trap "error_handler_build-machine" ERR INT TERM

	if [ "$FAST" = 1 ]; then
		sudo chmod -x "$WHONIX_SOURCE_FOLDER"/build-steps/20_create-debian-img
	fi

	run-parts --verbose --test ./build-steps
	run-parts --verbose --exit-on-error --arg "$MACHINE" ./build-steps

	if [ "$FAST" = 1 ]; then
		sudo chmod +x "$WHONIX_SOURCE_FOLDER"/build-steps/20_create-debian-img
	fi
}



whonix_build_all() {
	trap "error_handler_general" ERR INT TERM
	whonix_build_machine
}



whonix_build_clean() {
	trap "error_handler_general" ERR INT TERM
	MACHINE="-tg"
	./debug-steps/delete-vbox-vm "$MACHINE"
	MACHINE="-tw"
	./debug-steps/delete-vbox-vm "$MACHINE"
}



################################################################ 
# -tg                                                          #
################################################################ 
if [ "$1" = "-tg" ]; then
	MACHINE="-tg"
	whonix_build_machine "$MACHINE"
	exit 0
fi

################################################################ 
# -tw                                                          #
################################################################ 
if [[ "$1" = "-tw" ]]; then
	MACHINE="-tw"
	whonix_build_machine "$MACHINE"
	exit 0
fi

################################################################ 
# -all                                                         #
################################################################ 
if [[ "$1" = "-all" ]]; then
	MACHINE="-tg"
	whonix_build_machine "$MACHINE"
	MACHINE="-tw"
	whonix_build_machine "$MACHINE"
	exit 0
fi

################################################################ 
# -fast                                                        #
################################################################ 
if [[ "$1" = "-fast" ]]; then
        FAST=1
	MACHINE="-tg"
	whonix_build_machine "$MACHINE"
	MACHINE="-tw"
	whonix_build_machine "$MACHINE"
	exit 0
fi

################################################################ 
# -clean                                                       #
################################################################ 
if [[ "$1" = "-clean" ]]; then
	whonix_build_clean
	exit 0
fi

################################################################ 
# -help                                                        #
################################################################ 
if [[ "$1" = "-help" ]]; then
	script_help
	exit 0
fi

################################################################ 
# no option chosen                                             # 
################################################################ 
if [[ "$1" = "" ]]; then 
echo "
INFO: No option chosen.

Please append -help to find out more.
"
exit 0
fi