#!/bin/bash
## internally used by whonix_createvm

set -x

copy_backup_gateway() {
   trap "error_handler_int_whonix_image" ERR INT TERM

   ## Backup torrc inside VM before replacing it with Whonix version.
   cp --no-clobber "$CHROOT_FOLDER"/etc/tor/torrc "$CHROOT_FOLDER"/etc/tor/torrc.backup
}



copy_into_gateway() {
   trap "error_handler_int_whonix_image" ERR INT TERM

   ## copy skel to clearnet home
   cp --recursive --preserve "$CHROOT_FOLDER"/etc/skel/. "$CHROOT_FOLDER"/home/clearnet

   ## copy skel to user home is done in int_copy_shared

   ## Remove write protection from /etc/resolv.conf
   chattr -V -i "$CHROOT_FOLDER"/etc/resolv.conf

   ## Copy
   rsync --verbose --perms --recursive --checksum "$WHONIX_SOURCE_FOLDER"/whonix_gateway/ "$CHROOT_FOLDER"/

   ## Add write protection to resolv.conf to prevent DNS leaks by getting
   ## edited by DHCP.
   ## Do not override trap function, this step is essential.
   chattr -V +i "$CHROOT_FOLDER"/etc/resolv.conf

   ## This is required for chown --recursive clearnet:clearnet...
   echo "Creating clearnet user..."
   ## setting password of user clearnet to changeme
   ##
   ## How this password was created:
   ## sudo apt-get install whois
   ## mkpasswd
   ## changeme
   ## Resulted in: aTayYxVyw5kDo
   ##
   ## True in case script gets run again. (Debugging.)
   useradd --create-home --password aTayYxVyw5kDo --shell /bin/bash clearnet || true

   ## Fix /home/clearnet permissions.
   chown --recursive clearnet:clearnet "$CHROOT_FOLDER"/home/clearnet

   ## Fix /home/user permissions.
   chown --recursive user:user "$CHROOT_FOLDER"/home/user
}
