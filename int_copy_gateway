#!/bin/bash

set -x



copy_gateway_pre() {
   #########################
   # aos-Gateway Copy Pre  #
   #########################

   # Copy interfaces into VM.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/etc/network/interfaces "$CHROOT_FOLDER"/etc/network/interfaces

   # UGLY WORKAROUND:
   echo '#!/bin/bash

        echo "aos_firewall not active during build (aos_internal_install_script)."
        exit 0
   ' > "$CHROOT_FOLDER"/usr/local/bin/aos_firewall
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/aos_firewall

   # Copy VM script into VM image and make it executable.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/bin/aos_internal_install_script "$CHROOT_FOLDER"/usr/local/bin/
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/aos_internal_install_script

   # apt.conf currently empty and not used for anything.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/share/aos/apt.conf "$CHROOT_FOLDER"/usr/share/aos/apt.conf

   # Copy arm wrapper script to start arm into VM.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/bin/arm "$CHROOT_FOLDER"/usr/local/bin/arm
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/arm

   # Copy aos helpfile into VM.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/bin/aos "$CHROOT_FOLDER"/usr/local/bin/aos
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/aos

   # Create folder for vidalia.
   mkdir -p "$CHROOT_FOLDER"/home/user/.vidalia
   chown user "$CHROOT_FOLDER"/home/user/.vidalia

   # Copy aos-Gateway leaktest script into VM and make it executable.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/bin/leaktest "$CHROOT_FOLDER"/usr/local/bin/leaktest
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/leaktest

   # Just a marker that it is an aos_gateway. Used by torcheck script.
   touch "$CHROOT_FOLDER"/usr/share/aos/aos_gateway

   # Setup Vidalia to use Cookie Authentication.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/home/user/.vidalia/vidalia.conf "$CHROOT_FOLDER"/home/user/.vidalia/vidalia.conf
   chown user "$CHROOT_FOLDER"/home/user/.vidalia/vidalia.conf
}

append_gateway_pre() {
   ##########################
   # aos-Gateway Append Pre #
   ##########################

   # appendto_sources.list
   while read LINE; do
      echo $LINE >> "$CHROOT_FOLDER"/etc/apt/sources.list
   done < "$AOS_SOURCE_FOLDER"/aos_gateway/etc/apt/appendto_sources.list

   # Append aos help/welcome message to .bashrc.
   while read LINE; do
      echo $LINE >> "$CHROOT_FOLDER"/home/user/.bashrc
   done < "$AOS_SOURCE_FOLDER"/aos_gateway/home/user/appendto_.bashrc

   # Append to sysctl.conf.
   # IPv6 off, Forwarding off, fs.file-max to 100000, vm.swappiness to 0.
   while read LINE; do
      echo $LINE >> "$CHROOT_FOLDER"/etc/sysctl.conf
   done < "$AOS_SOURCE_FOLDER"/aos_gateway/etc/appendto_sysctl.conf
}

copy_gateway_post() {
   #########################
   # aos-Gateway Copy Post #
   #########################

   # No need to restore torrc. Will be replaced.

   # Backup torrc inside VM before replacing it with aos version.
   cp -n "$CHROOT_FOLDER"/etc/tor/torrc "$CHROOT_FOLDER"/etc/tor/torrc.backup

   # Copy aos firewall script into VM.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/bin/aos_firewall "$CHROOT_FOLDER"/usr/local/bin/aos_firewall
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/aos_firewall

   # apt-get uwt wrapper
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/bin/apt-get "$CHROOT_FOLDER"/usr/local/bin/apt-get
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/apt-get

   # gpg uwt wrapper
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/bin/gpg "$CHROOT_FOLDER"/usr/local/bin/gpg
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/gpg

   # htpdate uwt wrapper
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/sbin/htpdate "$CHROOT_FOLDER"/usr/local/bsin/htpdate
   chmod +x "$CHROOT_FOLDER"/usr/local/sbin/htpdate

   # wget uwt wrapper
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/usr/local/bin/wget "$CHROOT_FOLDER"/usr/local/bin/wget
   chmod +x "$CHROOT_FOLDER"/usr/local/bin/wget

   # Copy aos torrc into VM.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/etc/tor/torrc "$CHROOT_FOLDER"/etc/tor/torrc

   # Autologin, copy tty1.conf into VM.
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/etc/init/tty1.conf "$CHROOT_FOLDER"/etc/init/tty1.conf

   # Delete /etc/resolv.conf to work around some strange bug
   # "Operation not supported While reading flags on" while
   # trying to set -i on /etc/resolv.conf.
   # Override trap function, if /etc/resolv.conf does not
   # exist or is write protected (+i).
   rm "$CHROOT_FOLDER"/etc/resolv.conf || true

   # Remove write protection from resolv.conf.
   # Override trap function, if /etc/resolv.conf does not exist.
   chattr -i "$CHROOT_FOLDER"/etc/resolv.conf || true

   # Delete file to keep care of potential leaks.
   # Override trap function, if /etc/resolv.conf does not exist.
   rm "$CHROOT_FOLDER"/etc/resolv.conf || true

   # Set nameserver to localhost.
   # iptables redirects any of aos-Gateways DNS requests to DNS_PORT_AOSG
   # Do not override trap function, this step is essential.
   # resolv.conf
   cp "$AOS_SOURCE_FOLDER"/aos_gateway/etc/resolv.conf "$CHROOT_FOLDER"/etc/resolv.conf

   # Add write protection to resolv.conf to prevent DNS leaks by getting
   # edited by DHCP.
   # Do not override trap function, this step is essential.
   chattr +i "$CHROOT_FOLDER"/etc/resolv.conf 
}