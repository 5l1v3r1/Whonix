#!/bin/bash

## This file is part of Whonix.
## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

set -x
set -o pipefail

error_handler() {
   local exit_code="$?"
   local MSG="\
###############################################################################
## Please report this bug!
##
## BASH_COMMAND: $BASH_COMMAND
## exit_code: $exit_code
###############################################################################\
"
}

trap "error_handler" ERR

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
scriptname="$(basename "$0")"
[ -n "$tempfolder" ] || tempfolder="$(mktemp --directory)"

colors() {
   trap "error_handler" ERR

   ## Thanks to:
   ## http://mywiki.wooledge.org/BashFAQ/037
   ## Variables for terminal requests.
   [[ -t 2 ]] && {
      alt=$(      tput smcup  || tput ti      ) # Start alt display
      ealt=$(     tput rmcup  || tput te      ) # End   alt display
      hide=$(     tput civis  || tput vi      ) # Hide cursor
      show=$(     tput cnorm  || tput ve      ) # Show cursor
      save=$(     tput sc                     ) # Save cursor
      load=$(     tput rc                     ) # Load cursor
      bold=$(     tput bold   || tput md      ) # Start bold
      stout=$(    tput smso   || tput so      ) # Start stand-out
      estout=$(   tput rmso   || tput se      ) # End stand-out
      under=$(    tput smul   || tput us      ) # Start underline
      eunder=$(   tput rmul   || tput ue      ) # End   underline
      reset=$(    tput sgr0   || tput me      ) # Reset cursor
      blink=$(    tput blink  || tput mb      ) # Start blinking
      italic=$(   tput sitm   || tput ZH      ) # Start italic
      eitalic=$(  tput ritm   || tput ZR      ) # End   italic
      [[ $TERM != *-m ]] && {
      red=$(      tput setaf 1|| tput AF 1    )
      green=$(    tput setaf 2|| tput AF 2    )
      yellow=$(   tput setaf 3|| tput AF 3    )
      blue=$(     tput setaf 4|| tput AF 4    )
      magenta=$(  tput setaf 5|| tput AF 5    )
      cyan=$(     tput setaf 6|| tput AF 6    )
      }
      white=$(    tput setaf 7|| tput AF 7    )
      default=$(  tput op                     )
      eed=$(      tput ed     || tput cd      )   # Erase to end of display
      eel=$(      tput el     || tput ce      )   # Erase to end of line
      ebl=$(      tput el1    || tput cb      )   # Erase to beginning of line
      ewl=$eel$ebl                                # Erase whole line
      draw=$(     tput -S <<< '   enacs
                                      smacs
                                      acsc
                                      rmacs' || { \
                      tput eA; tput as;
                      tput ac; tput ae;         } )   # Drawing characters
      back=$'\b'
   } 2>/dev/null ||:
}

parse_files() {
   trap "error_handler" ERR

   for item in "$MYDIR/"*; do
      ## Ignore folders.
      if [ -d "$item" ]; then
         continue
      fi
      base_name="$(basename "$item")"
      ## Ignore this script itself.
      if [ "$base_name" = "$scriptname" ]; then
         continue
      fi
      file_extension="${base_name##*.}"
      if [ "$base_name" = "whonix_network.xml" ]; then
         continue
      fi
      if [ "$file_extension" = "xml" ]; then
         xml_orig="$item"
         domain_name="$(grep -oP '(?<=<name>).*(?=</name)' "$xml_orig")"
         continue
      fi
      true "item: $item"
      basename_without_extension="${base_name%.*}"
      version_number="$(echo "$base_name" | grep -Eo '[0-9]+\.[0-9]+')"
      vm_image="$item"
   done
}

get_domain_type() {
   trap "error_handler" ERR

   while true; do
      if [ ! "$domain_type" = "" ]; then
         echo "${green}INFO${reset}: domain type is $domain_type."
         break
      fi
      echo "\
${cyan}QUESTION${reset}: Which domain type do you want to use?
Type either:
${under}kvm${eunder}
or
${under}qemu${eunder}
then press enter."
      read domain_type
      if [ ! "$domain_type" = "" ]; then
         echo "${green}INFO${reset}: domain type is $domain_type."
         break
      fi
      echo "${red}ERROR${reset}: No domain type entered. Try again."
   done
}

validate_domain_type() {
   trap "error_handler" ERR

   if [ "$domain_type" = "kvm" ] || [ "$domain_type" = "qemu" ]; then
      return 0
   fi
   echo "${red}ERROR${reset}: Invalid domain type. Must be either ${under}kvm${eunder} or ${under}qemu${eunder}." >&2
   exit 1
}

change_domain_type_in_xml() {
   trap "error_handler" ERR

   if [ "$xml_orig" = "" ]; then
      echo "${red}ERROR${reset}: xml file could not be detected! Aborted." >&2
      exit 1
   fi
   if [ ! -f "$xml_orig" ]; then
      echo "${red}ERROR${reset}: xml file $xml_orig does not exist! Aborted." >&2
      exit 1
   fi

   cp "$xml_orig" "$tempfolder/temp.xml"

   temp="<domain type='kvm'>"
   new="<domain type='$domain_type'>"

   sed -i "s/$temp/$new/g" "$tempfolder/temp.xml"
}

check_for_existing_domain() {
   trap "error_handler" ERR

   if [ "$domain_name" = "" ]; then
      echo "${red}ERROR${reset}: domain_name could not be detected. Aborted." >&2
      exit 1
   fi

   virsh_dominfo_exit_code="0"
   virsh dominfo "$domain_name" >/dev/null 2>&1 || { virsh_dominfo_exit_code="$?" ; true; };

   if [ "$virsh_dominfo_exit_code" = "0" ]; then
      echo "${red}ERROR${reset}: Domain name $domain_name already exists. Aborted." >&2
      exit 1
   fi
}

import_domain() {
   trap "error_handler" ERR

   ## Check, if there is a network configuration file in this scripts's folder.
   if [ -f "./whonix_network.xml" ]; then
      ## Import virtual isolated network and to set it to autostart.
      virsh net-define ./whonix_network.xml
      virsh net-autostart ./whonix_network.xml
   fi

   ## Import VM.
   virsh define "$tempfolder/temp.xml"
}

check_for_existing_image() {
   trap "error_handler" ERR

   if [ -f "$vm_image" ]; then
      echo "${red}ERROR${reset}: Image $vm_image already exists. Aborted." >&2
      exit 1
   fi
}

copy_image() {
   trap "error_handler" ERR

   mkdir --parents "/var/lib/libvirt/images"
   ## TODO: Maybe use pv as progress bar, if available.
   cp "$vm_image" "/var/lib/libvirt/images/"
}

success() {
   trap "error_handler" ERR

   ## TODO: Better advice for user what to do next.
   echo "${green}INFO${reset}: Done." >&2
}

main_function() {
   trap "error_handler" ERR

   colors
   parse_files
   check_for_existing_domain
   check_for_existing_image
   get_domain_type
   validate_domain_type
   change_domain_type_in_xml
   import_domain
   copy_image
   success
}

main_function

#2a. It would change the generic value name such as whonix_gateway thats initially used in the config file
#and apply the new filedisk name to the path, the vm 'domain' name and  finally rename the actual image on disk to use that name :
#formatted like: whonix_gateway_$version_$containment+[alternative arch if selected for qemu].
