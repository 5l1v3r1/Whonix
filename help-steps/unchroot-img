#!/bin/bash

set -x

error_handler_unchroot-img() {
: echo "
${red}${bold}ERROR${reset} in $(caller)
${red}${bold}ERROR${reset} in $(caller)
${red}${bold}ERROR${reset} in $(caller)
"
exit 1
}

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source "$MYDIR"/pre
source "$MYDIR"/variables

do_unchroot() {
   trap "error_handler_unchroot-img" ERR INT TERM
   
   sync || true

   #umount "$CHROOT_FOLDER"/dev/pts || true
   umount "$CHROOT_FOLDER"/dev || true
   umount "$CHROOT_FOLDER"/proc || true
   #umount "$CHROOT_FOLDER"/sys || true
   umount "$CHROOT_FOLDER"/etc/resolv.conf || true
   umount "$WHONIX_INITIAL_DEB_INSTALL_FOLDER" || true
   
   rm --force "$CHROOT_FOLDER"/etc/apt/trusted.gpg.d/whonix-temporary-local-apt-repository.gpg
   rm --force "$WHONIX_SOURCES_LIST_TEMP_BUILD_FULL"

   sync || true
}

if [ "$BARE_METAL" = "1" ]; then
   true "${green}INFO${reset}: Skipping script, because BARE_METAL=1: $0"
   exit 0
else
   true "${bold}INFO${reset}: Currently running script: $0"
   do_unchroot
fi

