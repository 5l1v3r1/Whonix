#!/bin/bash

set -x

if [ "$BARE_METAL" = "1" ]; then
   true "${green}INFO${reset}: Skipping script, because BARE_METAL=1: $0"
   exit 0
else
   true "${bold}INFO${reset}: Currently running script: $0"
fi

error_handler_mount-img() {
: echo "
${red}${bold}ERROR${reset} in $(caller)
${red}${bold}ERROR${reset} in $(caller)
${red}${bold}ERROR${reset} in $(caller)
"
exit 1
}

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source "$MYDIR"/pre
source "$MYDIR"/variables

mount_img() {
   trap "error_handler_mount-img" ERR INT TERM

   sync
   
   kpartx -av "$WHONIX_BINARY"/"$VMNAME".img
   sync
   
   mkdir --parents "$CHROOT_FOLDER"
   sync
   
   mount /dev/mapper/loop0p1 "$CHROOT_FOLDER"
   sync
} 

mount_img

