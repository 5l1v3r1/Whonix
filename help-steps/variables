#!/bin/bash

set +x
#set -x

echo "Currently running script: $0"

export USERNAME="user"
export HOMEVAR="/home/"$USERNAME""

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
export WHONIX_SOURCE_FOLDER="$(dirname "$MYDIR")"
export WHONIX_SOURCE_PARENTDIR="$(dirname "$WHONIX_SOURCE_FOLDER")"

export DEBIAN_FRONTEND=noninteractive 

## Disable uwt while building Whonix,
## because it is not functional while building Whonix from source code.
export UWT_DEV_PASSTHROUGH="1"

export SNAPSHOT_DESCRIPTION="
   Reverts your Virtual Machine back to a clean state.
   All changes, all installed packages, all data you created will be lost!
"

## provides VERSION variable
source "$WHONIX_SOURCE_FOLDER"/help-steps/version

echo "VERSION: $VERSION"

if [ -z $VMNAME ]; then
   export VMNAME="unknown"
else
   true
fi

#echo "variables \$1: $1"
#echo "variables MACHINE: $MACHINE"

if [[ "$1" = "-tg" ]] || [[ "$MACHINE" = "-tg" ]]; then
   export MACHINE="-tg"
   export VMNAME="Whonix-Gateway"
   export VMRAM="768"
   export CHROOT_FOLDER="$HOMEVAR"/whonix_binary/"$VMNAME"_image
fi

if [[ "$1" = "-tg-bare-metal" ]] || [[ "$MACHINE" = "-tg-bare-metal" ]]; then
   export MACHINE="-tg-bare-metal"
   export VMNAME="Whonix-Gateway"
   export VMRAM="768"
   export CHROOT_FOLDER=""
   export BARE_METAL="1"
fi

if [[ "$1" = "-tw" ]] || [[ "$MACHINE" = "-tw" ]]; then
   export MACHINE="-tw"
   export VMNAME="Whonix-Workstation"
   export VMRAM="768"
   export CHROOT_FOLDER="$HOMEVAR"/whonix_binary/"$VMNAME"_image
fi

if [[ "$1" = "-tw-bare-metal" ]] || [[ "$MACHINE" = "-tw-bare-metal" ]]; then
   export MACHINE="-tw-bare-metal"
   export VMNAME="Whonix-Workstation"
   export VMRAM="768"
   export CHROOT_FOLDER=""
   export BARE_METAL="1"
fi

if [ "$1" = "-all" ]; then
   export VMNAME="-all"
fi

if [ "$1" = "-fast" ]; then
   export VMNAME="-fast"
fi

if [ "$1" = "-clean" ]; then
   export VMNAME="-clean"
fi

if [ "$1" = "-help" ]; then
   export VMNAME="-help"
fi

if [ -z $MACHINE ]; then
   if [ "$VMNAME" = "unknown" ]; then
      echo '
      : "ERROR:"
      : " "
      : "Read Build Documentation or"
      : "Physical Isolation Documentation (Bare Metal)"
      : " "
      : "Please add"
      : "-tg for Whonix-Gateway VM or,"
      : "-tw for Whonix-Workstation VM or,"
      : "-tg-bare-metal for Whonix-Gateway Bare Metal"
      : "-tw-bare-metal for Whonix-Workstation Bare Metal"
      '
      exit 1
   elif [ "$1" = "-buildscript" ]; then
      echo "Internal run for whonix_build -buildscript: $MACHINE"
   else
      echo "ERROR: Please report this BUG variables A!"
      exit 1
   fi
else
   if [ "$VMNAME" = "unknown" ]; then
      set -x
      bug "Variables: VMNAME is still unknown. Something went wrong. Please report this BUG."
      exit 1
   else
      echo "Variables: Internal run for: $MACHINE"
   fi
fi

if [ "$BARE_METAL" = "1" ]; then
   CHROOT=""
else
   CHROOT="chroot "$CHROOT_FOLDER"" 
fi   

export DEB_INSTALL_FOLDER="/var/lib/whonix/initialdeb"

export WHONIX_INITIAL_DEB_INSTALL_FOLDER=""$CHROOT_FOLDER"/"$DEB_INSTALL_FOLDER""

set -x

