#!/bin/bash

# This file is part of Whonix
# Copyright (C) 2012 - 2013 adrelanos <adrelanos at riseup dot net>
# See the file COPYING for copying conditions.

[ -o xtrace ]
## returns:
## - 0, if -x is set
## - 1, if -x is not set
MINUS_X_SET="$?"

set -x

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..

WHONIX_BUILD_PARSED="1"
VMNAME="internalrun"

cd help-steps
source pre

## Enable (1) or disable (0) debug_echo's.
debug="0"

script_help() {
   trap "error_handler_general" ERR INT TERM

   echo "\
Required options:
--ova ovafile
--report reportfile
--tempfolder folder

Optional options:
--topcomment comment
--endcomment comment
--errorcomment comment

Usage examples:
From Whonix Source Code Folder...

sudo ./help-steps/analyze_image --ova ~/Whonix-Gateway-7.4.3.ova --report ~/report1 --tempfolder ~/whonix_binary/report_temp1

sudo ./help-steps/analyze_image --ova ~/whonix_binary/Whonix-Gateway-7.4.3.ova --report ~/report2 --tempfolder ~/whonix_binary/report_temp2

From ~/whonix_binary folder...
vbindiff ./report_temp1/manual_analysis_folder/Whonix-Gateway-7.4.3.img.dd.1000000 ./report_temp2/manual_analysis_folder/Whonix-Gateway-7.4.3.img.dd.1000000

See https://www.whonix.org/wiki/Verifiable_Builds
and https://www.whonix.org/wiki/Trust"
}

parse_cmd() {
   trap "error_handler_general" ERR INT TERM

   ## Thanks to:
   ## http://mywiki.wooledge.org/BashFAQ/035

   if [ "$*" = "" ]; then
      error "no option chosen. Use --help."
   fi

   ## TODO:
   ## - specify .img or .vdi instead of .ova

   while :
   do
       case $1 in
           -h | --help | -\?)
               script_help
               exit 0
               ;;
           -o | --ova)
               ova_file="$2"
               shift 2
               ;;
           -r | --report)
               report_file="$2"
               shift 2
               ;;
           -t | --tempfolder)
               tempfolder="$2"
               shift 2
               ;;
           -c | --topcomment)
               topcomment="$2"
               shift 2
               ;;
           -e | --endcomment)
               endcomment="$2"
               shift 2
               ;;
           -f | --errorcomment)
              errorcomment="$2"
              shift 2
              ;;
           --)
               shift
               break
               ;;
           -*)
               error "unknown option: $1"
               ;;
           *)
               break
               ;;
       esac
   done

   if [ ! -f "$ova_file" ]; then
      if [ "$ova_file" = "baremetal" ]; then
         ## A bit of a hack.
         BARE_METAL="1"
      else
         echo "ERROR: ova_file $ova_file does not exist!"
         exit 1
      fi
   fi

   if [ "$report_file" = "" ]; then
      echo "ERROR: no report_file chosen!"
      exit 1
   fi
   if [ "$tempfolder" = "" ]; then
      echo "ERROR: no tempfolder chosen!"
      exit 1
   fi
}

error_handler() {
   local return_code="$?"
   local bash_command="$BASH_COMMAND"

   unmount_image

   echo "
${red}${bold}bash_command${reset}: $bash_command
${red}${bold}return_code${reset}: $return_code
"

   if [ "$errorcomment" = "" ]; then
      errorcomment="No error comment"
   fi

   errorcomment="$errorcomment
bash_command: $bash_command
return_code: $return_code"

   echo "$errorcomment" >> "$report_file"

   exit 1
}

trap "error_handler" ERR INT TERM

debug_echo() {
   trap "error_handler" ERR INT TERM
   if [ "$debug" = 1 ]; then
      echo "$*"
   fi
}

unmount_image() {
   if [ "$BARE_METAL" = "1" ]; then
      true "${bold}${cyan}INFO: Skipping $FUNCNAME, because BARE_METAL is 1."
      return 0
   fi

   true "${bold}${cyan}INFO: Unmounting vdi... ${reset}"

   sync

   guestunmount "$mount_folder"
   sync

   true "${bold}${cyan}INFO: Unmounted vdi. ${reset}"
}

preparation() {
   trap "error_handler" ERR INT TERM

   rm --force "$report_file"
   rm --force "$file_list_file"
   sync

   sudo -u "$USERNAME" touch "$report_file"
   sync

   if [ "$BARE_METAL" = "1" ]; then
      mount_folder=""
   else
      mount_folder="$tempfolder/mount_folder"
   fi

   extracted_ova_folder="$tempfolder/extracted_ova_folder"
   vdi_folder="$tempfolder/vdi_folder"
   raw_folder="$tempfolder/raw_folder"
   auto_hash_folder="$tempfolder/auto_hash_folder"
   initrd_folder="$tempfolder/initrd_folder"
   extracted_initrd_folder="$tempfolder/extracted_initrd_folder"
   debug_folder="$tempfolder/debug_folder"
   manual_analysis_folder="$tempfolder/manual_analysis_folder"

   ova_absolute_filename_without_extension="${ova_file%.*}"
   folder_name="$(dirname "$ova_file")"
   ova_filename="$(basename "$ova_file")"
   ova_filename_without_extension="${ova_filename%.*}"

   ## Example ova_absolute_filename_without_extension:
   ## /home/user/whonix_binary/Whonix-Gateway-7

   vmdk_file="$extracted_ova_folder/$ova_filename_without_extension-disk1.vmdk"
   vdi_file="$vdi_folder/$ova_filename_without_extension.vdi"
   raw_file="$raw_folder/$ova_filename_without_extension.img"

   vmdk_file_basename="$(basename "$vmdk_file")"
   vdi_file_basename="$(basename "$vdi_file")"
   raw_file_basename="$(basename "$raw_file")"

   file_list_file="$auto_hash_folder/file_list"

   sudo -u "$USERNAME" mkdir --parents "$extracted_ova_folder"
   sudo -u "$USERNAME" mkdir --parents "$mount_folder" || true
   sudo -u "$USERNAME" mkdir --parents "$vdi_folder"
   sudo -u "$USERNAME" mkdir --parents "$raw_folder"
   sudo -u "$USERNAME" mkdir --parents "$auto_hash_folder"
   sudo -u "$USERNAME" mkdir --parents "$initrd_folder"
   sudo -u "$USERNAME" mkdir --parents "$extracted_initrd_folder"
   sudo -u "$USERNAME" mkdir --parents "$debug_folder"
   sudo -u "$USERNAME" mkdir --parents "$manual_analysis_folder"
   sync
}

parse_topcomment() {
   trap "error_handler" ERR INT TERM

   if [ "$topcomment" = "" ]; then
      topcomment="No topcomment."
   fi
   echo "$topcomment" >> "$report_file"
}

extract_ova() {
   trap "error_handler" ERR INT TERM

   if [ "$BARE_METAL" = "1" ]; then
      true "${bold}${cyan}INFO: Skipping $FUNCNAME, because BARE_METAL is 1."
      return 0
   fi

   cd "$extracted_ova_folder"

   if [ -f "$vdi_file" ]; then
      true "${bold}${cyan}INFO: Unpacking .ova not required, .vdi already exists, skipping. ${reset}"
   else
      if [ ! -f "$ova_file" ]; then
         error "${red}${bold}ERROR: $ova_file does not exist. ${reset}"
      else
         true "${bold}${cyan}INFO: Unpacking ova: $ova_file... (This can take a while.) ${reset}"
         sudo -u "$USERNAME" tar -xvf "$ova_file"
         true "${bold}${cyan}INFO: Unpacked ova_file. ${reset}"
      fi
   fi
}

convert_vmdk_to_vdi() {
   trap "error_handler" ERR INT TERM

   if [ "$BARE_METAL" = "1" ]; then
      true "${bold}${cyan}INFO: Skipping $FUNCNAME, because BARE_METAL is 1."
      return 0
   fi

   if [ ! -f "$vmdk_file" ]; then
      error "${red}${bold}ERROR: vmdk_file: $vmdk_file does not exist. ${reset}"
   fi

   if [ -f "$vdi_file" ]; then
      true "${bold}${cyan}INFO: Converting vmdk to vdi not required, already done, skipping. ${reset}"
   else
      ## Convert .vmdk to .vdi, since there is no Free Software for mounting .vmdk using command line.
      true "${bold}${cyan}INFO: Converting vmdk to vdi... (This can take a while.) ${reset}"

      ## qemu-img version 1.6.1 fails with:
      ## qemu-img: 'image' uses a vmdk feature which is not supported by this qemu version: VMDK version 3
      ## https://bugs.launchpad.net/qemu/+bug/1253465
      #sudo -u "$USERNAME" qemu-img convert "$vmdk_file" -O RAW "$vdi_file"

      sudo -u "$USERNAME" VBoxManage clonehd --format VDI "$vmdk_file" "$vdi_file"

      true "${bold}${cyan}INFO: Converted vmdk to vdi. ${reset}"
   fi
}

convert_vdi_to_raw() {
   trap "error_handler" ERR INT TERM

   if [ "$BARE_METAL" = "1" ]; then
      true "${bold}${cyan}INFO: Skipping $FUNCNAME, because BARE_METAL is 1."
      return 0
   fi

   if [ -f "$raw_file" ]; then
      true "${bold}${cyan}INFO: Converting vdi to raw not required, already done, skipping. ${reset}"
   else
      true "${bold}${cyan}INFO: Converting vdi to img... (This can take a while.) ${reset}"

      sudo -u "$USERNAME" qemu-img convert -p -O raw "$vdi_file" "$raw_file"

      true "${bold}${cyan}INFO: Converted vdi to img. ${reset}"
   fi
}

mount_image() {
   trap "error_handler" ERR INT TERM

   if [ "$BARE_METAL" = "1" ]; then
      true "${bold}${cyan}INFO: Skipping $FUNCNAME, because BARE_METAL is 1."
      return 0
   fi

   true "${bold}${cyan}INFO: Mounting vdi... ${reset}"

   sync

   ## Mounting read-only so the user can not accidentally delete files within the image.
   guestmount -o allow_other -a "$vdi_file" -m /dev/sda1 --ro "$mount_folder"
   sync

   true "${bold}${cyan}INFO: Mounted vdi. ${reset}"
}

parse_file_system() {
   trap "error_handler" ERR INT TERM

   if [ "$BARE_METAL" = "1" ]; then
      true "${bold}${cyan}INFO: Skipping $FUNCNAME, because BARE_METAL is 1."
      return 0
   fi

   true "${bold}${cyan}INFO: Parsing file systems... ${reset}"

   virt-filesystems -a "$vdi_file" > "$auto_hash_folder/$vdi_file_basename.virt-filesystems-a"
   virt-filesystems -a "$raw_file" > "$auto_hash_folder/$raw_file_basename.virt-filesystems-a"

   true "${bold}${cyan}INFO: Parsed file systems. ${reset}"
}

parse_mbr() {
   trap "error_handler" ERR INT TERM

   if [ "$BARE_METAL" = "1" ]; then
      true "${bold}${cyan}INFO: Skipping $FUNCNAME, because BARE_METAL is 1."
      return 0
   fi

   true "${bold}${cyan}INFO: Parsing MBR... ${reset}"

   ## ~1 MB
   dd if="$raw_file" of="$manual_analysis_folder/$raw_file_basename.dd.1000000" bs=1000000 count=1

   true "${bold}${cyan}INFO: Parsed MBR. ${reset}"
}

parse_vbr() {
   trap "error_handler" ERR INT TERM

   if [ "$BARE_METAL" = "1" ]; then
      true "${bold}${cyan}INFO: Skipping $FUNCNAME, because BARE_METAL is 1."
      return 0
   fi

   true "${bold}${cyan}INFO: Parsing VBR... ${reset}"

   guestfish --ro -a "$raw_file" : pread-device /dev/sda1 512 0 > "$auto_hash_folder/$raw_file_basename.sda1_pread-device.512"

   true "${bold}${cyan}INFO: Parsed VBR. ${reset}"
}

parse_special_files() {
   trap "error_handler" ERR INT TERM

   sudo -u "$USERNAME" cp "$mount_folder/usr/share/whonix/build_timestamp" "$manual_analysis_folder/usr_share_whonix_build_timestamp"
   echo "$manual_analysis_folder/build_timestamp BEGIN..."
   sudo -u "$USERNAME" cat "$manual_analysis_folder/usr_share_whonix_build_timestamp"
   echo "END $manual_analysis_folder/build_timestamp."

   ## {{ manual_analysis_folder

   if [ "$CI" = "true" ]; then
      ## Reading /etc/shadow does usually not work on CI systems. Not even as root.
      sudo -u "$USERNAME" cp "$mount_folder/etc/shadow" "$manual_analysis_folder/etc_shadow" || true
      sudo -u "$USERNAME" cp "$mount_folder/etc/shadow-" "$manual_analysis_folder/etc_shadow-" || true
   else
      sudo -u "$USERNAME" cp "$mount_folder/etc/shadow" "$manual_analysis_folder/etc_shadow"
      sudo -u "$USERNAME" cp "$mount_folder/etc/shadow-" "$manual_analysis_folder/etc_shadow-"
   fi

   ## "|| true", because CI (Ubuntu) and custom builders may not use sysvinit.
   sudo -u "$USERNAME" cp "$mount_folder/etc/init.d/.depend.boot" "$manual_analysis_folder/etc_init.d_.depend.boot" || true
   sudo -u "$USERNAME" cp "$mount_folder/etc/init.d/.depend.start" "$manual_analysis_folder/etc_init.d_.depend.start" || true
   sudo -u "$USERNAME" cp "$mount_folder/etc/init.d/.depend.stop" "$manual_analysis_folder/etc_init.d_.depend.stop" || true

   sudo -u "$USERNAME" cp "$mount_folder/etc/fstab" "$manual_analysis_folder/etc_fstab"

   sudo -u "$USERNAME" mkdir --parents "$manual_analysis_folder/var_lib_initramfs-tools"

   if [ "$CI" = "true" ]; then
      sudo -u "$USERNAME" cp "$mount_folder/var/lib/initramfs-tools/"* "$manual_analysis_folder/var_lib_initramfs-tools/" || true
   else
      sudo -u "$USERNAME" cp "$mount_folder/var/lib/initramfs-tools/"* "$manual_analysis_folder/var_lib_initramfs-tools/"
   fi

   ## }}

   ## {{ debug_folder

   sudo -u "$USERNAME" cp "$mount_folder/usr/share/whonix/build_version" "$debug_folder/usr_share_whonix_build_version"

   sudo -u "$USERNAME" cp "$mount_folder/etc/debootstrap/config" "$debug_folder/etc_debootstrap_config" || true
   sudo -u "$USERNAME" cp "$mount_folder/etc/debootstrap/stages/default_locales" "$debug_folder/etc_debootstrap_stages_default_locales" || true

   sudo -u "$USERNAME" mkdir --parents "$debug_folder/usr_share_doc_whonix-x"

   rm --force "$debug_folder/usr_share_doc_whonix-x/file_list"
   local i
   i="0"
   local file

   for file in "$mount_folder/usr/share/doc/whonix-"*"/changelog.Debian.gz"; do
      i="$(expr "$i" + "1")"
      echo "$i $file" >> "$debug_folder/usr_share_doc_whonix-x/file_list"
      sudo -u "$USERNAME" cp "$file" "$debug_folder/usr_share_doc_whonix-x/changelog.Debian.gz.$i"
   done

   unset file

   sudo -u "$USERNAME" mkdir --parents "$debug_folder/var_lib_dpkg_info_whonix-x"
   sudo -u "$USERNAME" cp "$mount_folder/var/lib/dpkg/info/whonix-"*".md5sums" "$debug_folder/var_lib_dpkg_info_whonix-x/"

   ## "|| true", because that file usually gets deleted.
   sudo -u "$USERNAME" cp "$mount_folder/var/cache/apt/pkgcache.bin" "$debug_folder/var_cache_apt_pkgcache.bin" || true

   ## "|| true", because that those files usually get deleted.
   sudo -u "$USERNAME" cp "$mount_folder/var/lib/dpkg/available" "$debug_folder/var_lib_dpkg_available" || true
   sudo -u "$USERNAME" cp "$mount_folder/var/lib/dpkg/available-old" "$debug_folder/var_lib_dpkg_available-old" || true

   ## }}
}

parse_initrd() {
   trap "error_handler" ERR INT TERM

   ## Debugging.
   ls -la "$mount_folder/boot/" || true

   if [ "$CI" = "true" ]; then
      sudo -u "$USERNAME" cp "$mount_folder/boot/initrd.img"* "$initrd_folder" || true
   else
      sudo -u "$USERNAME" cp "$mount_folder/boot/initrd.img"* "$initrd_folder"
   fi

   local file

   for file in "$initrd_folder"/*; do
      cd "$extracted_initrd_folder"
      true "file: $file"
      local basename_file
      basename_file="$(basename "$file")"
      if [ "$basename_file" = "*" ]; then
         continue
      fi
      sudo -u "$USERNAME" mkdir --parents "$basename_file"
      cd "$basename_file"
      sudo -u "$USERNAME" gzip -dc < "$file" | sudo -u "$USERNAME" cpio -i
   done
}

parse_folder() {
   trap "error_handler" ERR INT TERM

   local i
   i="0"

   if [ "$CI" = "true" ]; then
      ## This is unfortunately required to avoid the following error.
      ## "The log length has exceeded the limit of 4 Megabytes (this usually means that test suite is raising the same exception over and over).
      ## The build has been terminated."
      local parse_max
      parse_max="100"
   fi

   rm --force "$file_list_file"

   local sub_folder
   sub_folder="$(basename "$folder/")"

   local file

   set +x

   while read -r -d '' file; do
      i="$(expr "$i" + "1")"

      if [ "$CI" = "true" ]; then
         if [ "$i" -gt "$parse_max" ]; then
            echo "($sub_folder) parse_max $parse_max reached. Skipping the remaining files."
            echo "($sub_folder) parse_max $parse_max reached. Skipping the remaining files." >> "$report_file"
            break
         fi
      fi

      local absolute_file_name
      absolute_file_name="${file#"$folder"}"

      echo "$absolute_file_name: $file"
      echo "$absolute_file_name" >> "$file_list_file"

      if [ -d "$file" ]; then
         echo "($sub_folder) $absolute_file_name: directory" >> "$report_file"
         continue
      fi

      local dir_name
      dir_name="${file%/*}"
      local dir_name_absolute
      dir_name_absolute="${dir_name#"$folder"}"

      ## Check if $file is a symlink.
      if [ -h "$file" ]; then
         ## Symlink found...

         ## Not using readlink with -f, so we can compare the relative links.
         local file_link
         file_link="$(readlink "$file")"
         echo "($sub_folder) $absolute_file_name: symlinks_to $file_link" >> "$report_file"

         continue
      fi

      if [ "$skip" = "1" ]; then
         local file_extension
         file_extension="${file##*.}"
         if [ "$file_extension" = "vmdk" ] || [ "$file_extension" = "mf" ] || [ "$file_extension" = "ovf" ]; then
            ## Skipping creating a sha512sum of the vmdk, because that wastes
            ## a lot time and we know in advance, there there will be
            ## differences. (Because there are no deterministically built
            ## operating systems yet.) We mount and analyze that image later,
            ## which is the whole point of this script.
            ##
            ## Skipping creation of sha512sum for mf and ovf file because those
            ## contain checksums and disk uuids which we expect to differ.
            ## Auditors are advised to manually diff those files.
            ##
            ## Still useful to have the file name and "skipped" in the report
            ## file, because this is a reminder to diff the mf and the ofv file
            ## and because the ova could also contain more than the three
            ## expected files.
            echo "($sub_folder) $absolute_file_name: skipped" >> "$report_file"
            continue
         fi
      fi

      if [ "$absolute_file_name" = "/dev/xconsole" ]; then
         echo "($sub_folder) $absolute_file_name: skipped" >> "$report_file"
         continue
      fi
      if [ "$absolute_file_name" = "/dev/initctl" ]; then
         echo "($sub_folder) $absolute_file_name: skipped" >> "$report_file"
         continue
      fi

      local maybe_timeout
      if [ "$CI" = "true" ] || [ "$BARE_METAL" = "1" ]; then
         if [[ "$absolute_file_name" == "/dev/"** ]]; then
            maybe_timeout="timeout --kill-after=1 1"
         else
            maybe_timeout=""
         fi
      else
         maybe_timeout=""
      fi

      local checksum_return
      local checksum_exit_code
      checksum_exit_code="0"
      checksum_return="$($maybe_timeout sha512sum "$file")" || { checksum_exit_code="${PIPESTATUS[0]}" ; true; };
      if [ ! "$checksum_exit_code" = "0" ]; then
         ## Handling cases such as:
         ## sha512sum /home/user/whonix_binary/$tempfolder/mount_folder/dev/ida/c2d10p14
         ## sha512sum: /home/user/whonix_binary/$tempfolder/mount_folder/dev/ida/c2d10p14: Permission denied
         echo "($sub_folder) $absolute_file_name: $checksum_exit_code" >> "$report_file"
         continue
      else
         local checksum
         read -r checksum _ <<< "$checksum_return"
         echo "($sub_folder) $absolute_file_name: $checksum" >> "$report_file"
         continue
      fi
   done < <(find "$folder/" -print0 | sort -z)

   set -x
}

parse_file_list_file() {
   trap "error_handler" ERR INT TERM

   sha512sum "$file_list_file" >> "$report_file"
}

parse_endcomment() {
   trap "error_handler" ERR INT TERM

   if [ "$endcomment" = "" ]; then
      endcomment="No endcomment."
   fi

   echo "$endcomment" >> "$report_file"
}

end() {
   trap "error_handler" ERR INT TERM

   unmount_image

   true "${bold}${cyan}INFO: End. No error detected. ${reset}"
}

parse_cmd ${1+"$@"}
preparation
parse_topcomment

extract_ova
convert_vmdk_to_vdi
convert_vdi_to_raw

parse_file_system
parse_vbr
parse_mbr

mount_image

parse_special_files
parse_initrd

skip="1"
folder="$extracted_ova_folder"
parse_folder

skip="0"
folder="$auto_hash_folder"
parse_folder

skip="0"
folder="$extracted_initrd_folder"
parse_folder

skip="0"
folder="$mount_folder"
parse_folder

parse_file_list_file

parse_endcomment
end
